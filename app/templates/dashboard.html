<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Orquestador de Voz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-[1600px]"> <!-- Wider container -->
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
                Orquestador de Voz Nativo
            </h1>
            <div class="px-3 py-1 bg-slate-800 rounded-full text-xs font-mono">
                Estado: <span class="text-emerald-400">‚óè En L√≠nea</span>
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-12 gap-6 relative">
            <!-- Configuration Panel (Left, Scrollable naturally) -->
            <div class="sm:col-span-5 lg:col-span-4 bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-xl">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Configuraci√≥n</h2>
                <script src="//unpkg.com/alpinejs" defer></script>

                <div x-data="{ 
                    tab: 'model', 
                    activeProfile: 'browser',
                    interruptionPhone: {{ config.interruption_threshold_phone or 2 }},
                    voiceSpeedPhone: {{ config.voice_speed_phone or 0.9 }},
                    silencePhone: {{ config.silence_timeout_ms_phone or 1200 }},
                    
                    /* Telnyx State */
                    interruptionTelnyx: {{ config.interruption_threshold_telnyx or 2 }},
                    voiceSpeedTelnyx: {{ config.voice_speed_telnyx or 0.9 }},
                    silenceTelnyx: {{ config.silence_timeout_ms_telnyx or 1200 }},

                    /* History State */
                    historyFilter: 'all'
                }">
                    <!-- Tabs Header (RESTORED FOR HISTORY ACCESS) -->
                    <div class="flex space-x-1 border-b border-slate-700 mb-4 overflow-x-auto pb-1 custom-scrollbar">
                        <!-- Model (Disabled/Hidden) -->
                        <button @click.prevent="tab = 'model'"
                            :class="tab === 'model' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                            class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap opacity-50 cursor-not-allowed"
                            title="Auditando...">Modelo</button>

                        <!-- Voice (Disabled/Hidden) -->
                        <button @click.prevent="tab = 'voice'"
                            :class="tab === 'voice' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                            class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap opacity-50 cursor-not-allowed"
                            title="Auditando...">Voz</button>

                        <!-- Transcriber (Disabled/Hidden) -->
                        <button @click.prevent="tab = 'transcriber'"
                            :class="tab === 'transcriber' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                            class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap opacity-50 cursor-not-allowed"
                            title="Auditando...">Transcriptor</button>

                        <!-- Functions (RESTORED) -->
                        <button @click.prevent="tab = 'functions'"
                            :class="tab === 'functions' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                            class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Funciones</button>

                        <!-- Advanced (RESTORED) -->
                        <button @click.prevent="tab = 'advanced'"
                            :class="tab === 'advanced' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                            class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Avanzado</button>

                        <!-- HISTORY (ACTIVE) -->
                        <button @click.prevent="tab = 'history'"
                            :class="tab === 'history' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                            class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Historial</button>

                        <!-- Connectivity (Disabled/Hidden) -->
                        <button @click.prevent="tab = 'connectivity'"
                            :class="tab === 'connectivity' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                            class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap opacity-50 cursor-not-allowed"
                            title="Auditando...">Conexi√≥n</button>
                    </div>

                    <!-- GLOBAL PROFILE TOGGLE -->
                    <div class="flex space-x-2 bg-slate-900/50 rounded-lg p-1 mb-4 border border-slate-700">
                        <button type="button"
                            @click="activeProfile = 'browser'; document.getElementById('sim-mode-text').innerText = 'Navegador'; document.getElementById('sim-mode-text').className = 'text-blue-400'; window.simulatorClientType = 'browser';"
                            :class="{'bg-blue-600 text-white shadow-lg': activeProfile === 'browser', 'text-slate-400 hover:text-white': activeProfile !== 'browser'}"
                            class="flex-1 py-1.5 px-3 rounded text-sm font-bold transition-all focus:outline-none flex items-center justify-center gap-2">
                            <span>üåê</span> Simulador
                        </button>
                        <button type="button"
                            @click="activeProfile = 'twilio'; document.getElementById('sim-mode-text').innerText = 'Twilio'; document.getElementById('sim-mode-text').className = 'text-red-400'; window.simulatorClientType = 'twilio';"
                            :class="{'bg-red-600 text-white shadow-lg': activeProfile === 'twilio', 'text-slate-400 hover:text-white': activeProfile !== 'twilio'}"
                            class="flex-1 py-1.5 px-3 rounded text-sm font-bold transition-all focus:outline-none flex items-center justify-center gap-2">
                            <span>üì±</span> Twilio
                        </button>
                        <button type="button"
                            @click="activeProfile = 'telnyx'; document.getElementById('sim-mode-text').innerText = 'Telnyx'; document.getElementById('sim-mode-text').className = 'text-emerald-400'; window.simulatorClientType = 'telnyx';"
                            :class="{'bg-emerald-600 text-white shadow-lg': activeProfile === 'telnyx', 'text-slate-400 hover:text-white': activeProfile !== 'telnyx'}"
                            class="flex-1 py-1.5 px-3 rounded text-sm font-bold transition-all focus:outline-none flex items-center justify-center gap-2">
                            <span>üì°</span> Telnyx
                        </button>
                    </div>

                    <form action="/api/config/update" method="POST" class="space-y-4"
                        onsubmit="event.preventDefault(); saveConfig();">
                        <!-- HIDDEN INPUTS AND FORM CONTENT SAME AS BEFORE (RELYING ON CONTEXT MATCH) -->
                        <input type="hidden" name="stt_provider" value="azure">
                        <input type="hidden" name="llm_provider" value="groq">
                        <input type="hidden" name="tts_provider" value="azure">

                        <!-- FROZEN CONFIGURATION STATE (AUDIT MODE) -->
                        <div style="display:none;">
                            <!-- CORE & MODEL -->
                            <input type="hidden" name="llm_model" value="{{ config.llm_model }}">
                            <input type="hidden" name="extraction_model" value="{{ config.extraction_model }}">
                            <input type="hidden" name="max_tokens" value="{{ config.max_tokens }}">
                            <input type="hidden" name="first_message_mode" value="{{ config.first_message_mode }}">
                            <input type="hidden" name="first_message" value="{{ config.first_message }}">
                            <input type="hidden" name="system_prompt" value="{{ config.system_prompt }}">
                            <input type="hidden" name="temperature" value="{{ config.temperature }}">

                            <!-- CORE PHONE (TWILIO) -->
                            <input type="hidden" name="llm_model_phone" value="{{ config.llm_model_phone }}">
                            <input type="hidden" name="llm_provider_phone" value="{{ config.llm_provider_phone }}">
                            <input type="hidden" name="max_tokens_phone" value="{{ config.max_tokens_phone }}">
                            <input type="hidden" name="first_message_mode_phone"
                                value="{{ config.first_message_mode_phone }}">
                            <input type="hidden" name="first_message_phone" value="{{ config.first_message_phone }}">
                            <input type="hidden" name="system_prompt_phone" value="{{ config.system_prompt_phone }}">
                            <input type="hidden" name="temperature_phone" value="{{ config.temperature_phone }}">

                            <!-- CORE TELNYX -->
                            <input type="hidden" name="llm_model_telnyx" value="{{ config.llm_model_telnyx }}">
                            <input type="hidden" name="llm_provider_telnyx" value="{{ config.llm_provider_telnyx }}">
                            <input type="hidden" name="max_tokens_telnyx" value="{{ config.max_tokens_telnyx }}">
                            <input type="hidden" name="first_message_mode_telnyx"
                                value="{{ config.first_message_mode_telnyx }}">
                            <input type="hidden" name="first_message_telnyx" value="{{ config.first_message_telnyx }}">
                            <input type="hidden" name="system_prompt_telnyx" value="{{ config.system_prompt_telnyx }}">
                            <input type="hidden" name="temperature_telnyx" value="{{ config.temperature_telnyx }}">

                            <!-- VOICE -->
                            <input type="hidden" name="voice_name" value="{{ config.voice_name }}">
                            <input type="hidden" name="voice_style" value="{{ config.voice_style or '' }}">
                            <input type="hidden" name="voice_speed" value="{{ config.voice_speed }}">
                            <input type="hidden" name="voice_pacing_ms" value="{{ config.voice_pacing_ms }}">

                            <!-- VOICE PHONE -->
                            <input type="hidden" name="voice_name_phone" value="{{ config.voice_name_phone }}">
                            <input type="hidden" name="voice_style_phone" value="{{ config.voice_style_phone or '' }}">
                            <input type="hidden" name="voice_speed_phone" value="{{ config.voice_speed_phone }}">
                            <input type="hidden" name="voice_pacing_ms_phone"
                                value="{{ config.voice_pacing_ms_phone }}">

                            <!-- VOICE TELNYX -->
                            <input type="hidden" name="voice_name_telnyx" value="{{ config.voice_name_telnyx }}">
                            <input type="hidden" name="voice_style_telnyx"
                                value="{{ config.voice_style_telnyx or '' }}">
                            <input type="hidden" name="voice_speed_telnyx" value="{{ config.voice_speed_telnyx }}">
                            <input type="hidden" name="voice_pacing_ms_telnyx"
                                value="{{ config.voice_pacing_ms_telnyx }}">
                            <input type="hidden" name="voice_sensitivity_telnyx"
                                value="{{ config.voice_sensitivity_telnyx }}">

                            <!-- VOICE EXTRAS -->
                            <input type="hidden" name="voice_id_manual" value="{{ config.voice_id_manual or '' }}">
                            <input type="hidden" name="background_sound" value="{{ config.background_sound }}">
                            <!-- input_min_characters is handled below but we add here for safety if not duplicated -->
                            <input type="hidden" name="background_sound_url"
                                value="{{ config.background_sound_url or '' }}">

                            <!-- TRANSCRIBER & FUNCTIONS -->
                            <input type="hidden" name="stt_language" value="{{ config.stt_language }}">
                            <input type="hidden" name="silence_timeout_ms" value="{{ config.silence_timeout_ms }}">
                            <input type="hidden" name="segmentation_max_time"
                                value="{{ config.segmentation_max_time }}">
                            <input type="hidden" name="interruption_threshold"
                                value="{{ config.interruption_threshold }}">
                            <input type="hidden" name="input_min_characters" value="{{ config.input_min_characters }}">
                            <input type="hidden" name="hallucination_blacklist"
                                value="{{ config.hallucination_blacklist }}">
                            <input type="hidden" name="enable_denoising" value="{{ config.enable_denoising }}">

                            <!-- TRANSCRIBER PHONE -->
                            <input type="hidden" name="stt_provider_phone" value="{{ config.stt_provider_phone }}">
                            <input type="hidden" name="stt_language_phone" value="{{ config.stt_language_phone }}">
                            <input type="hidden" name="interruption_threshold_phone"
                                value="{{ config.interruption_threshold_phone }}">
                            <input type="hidden" name="silence_timeout_ms_phone"
                                value="{{ config.silence_timeout_ms_phone }}">
                            <input type="hidden" name="input_min_characters_phone"
                                value="{{ config.input_min_characters_phone }}">
                            <input type="hidden" name="hallucination_blacklist_phone"
                                value="{{ config.hallucination_blacklist_phone }}">
                            <input type="hidden" name="enable_denoising_phone"
                                value="{{ config.enable_denoising_phone }}">

                            <!-- TRANSCRIBER TELNYX -->
                            <input type="hidden" name="stt_provider_telnyx" value="{{ config.stt_provider_telnyx }}">
                            <input type="hidden" name="stt_language_telnyx" value="{{ config.stt_language_telnyx }}">
                            <input type="hidden" name="interruption_threshold_telnyx"
                                value="{{ config.interruption_threshold_telnyx }}">
                            <input type="hidden" name="silence_timeout_ms_telnyx"
                                value="{{ config.silence_timeout_ms_telnyx }}">
                            <input type="hidden" name="input_min_characters_telnyx"
                                value="{{ config.input_min_characters_telnyx }}">
                            <input type="hidden" name="hallucination_blacklist_telnyx"
                                value="{{ config.hallucination_blacklist_telnyx }}">
                            <input type="hidden" name="enable_denoising_telnyx"
                                value="{{ config.enable_denoising_telnyx }}">

                            <!-- TELNYX FEATURES -->
                            <input type="hidden" name="enable_krisp_telnyx" value="{{ config.enable_krisp_telnyx }}">
                            <input type="hidden" name="enable_vad_telnyx" value="{{ config.enable_vad_telnyx }}">

                            <!-- TWILIO FEATURES -->
                            <input type="hidden" name="twilio_machine_detection"
                                value="{{ config.twilio_machine_detection }}">
                            <input type="hidden" name="twilio_record" value="{{ config.twilio_record }}">
                            <input type="hidden" name="twilio_trim_silence" value="{{ config.twilio_trim_silence }}">

                            <!-- ADVANCED -->
                            <input type="hidden" name="idle_timeout" value="{{ config.idle_timeout }}">
                            <input type="hidden" name="idle_message" value="{{ config.idle_message }}">
                            <input type="hidden" name="max_duration" value="{{ config.max_duration }}">
                            <input type="hidden" name="idle_timeout_telnyx" value="{{ config.idle_timeout_telnyx }}">
                            <input type="hidden" name="max_duration_telnyx" value="{{ config.max_duration_telnyx }}">
                            <input type="hidden" name="idle_message_telnyx" value="{{ config.idle_message_telnyx }}">
                            <input type="hidden" name="enable_recording_telnyx"
                                value="{{ config.enable_recording_telnyx }}">
                            <input type="hidden" name="amd_config_telnyx" value="{{ config.amd_config_telnyx }}">
                            <input type="hidden" name="initial_silence_timeout_ms"
                                value="{{ config.initial_silence_timeout_ms }}">
                            <input type="hidden" name="initial_silence_timeout_ms_phone"
                                value="{{ config.initial_silence_timeout_ms_phone }}">
                            <input type="hidden" name="initial_silence_timeout_ms_telnyx"
                                value="{{ config.initial_silence_timeout_ms_telnyx }}">
                            <input type="hidden" name="punctuation_boundaries"
                                value="{{ config.punctuation_boundaries or '' }}">
                            <input type="hidden" name="enable_end_call" value="{{ config.enable_end_call }}">
                            <input type="hidden" name="enable_dial_keypad" value="{{ config.enable_dial_keypad }}">
                            <input type="hidden" name="transfer_phone_number"
                                value="{{ config.transfer_phone_number or '' }}">
                            <input type="hidden" name="segmentation_strategy"
                                value="{{ config.segmentation_strategy }}">
                            <input type="hidden" name="twilio_recording_channels"
                                value="{{ config.twilio_recording_channels }}">
                        </div>
                        <!-- Tab: Functions -->
                        <!-- üîí LOCKED SECTION: PANEL FUNCIONES (RESTORED PER REQUEST) -->
                        <div x-show="tab === 'functions'" class="space-y-4" style="display: none;">
                            <h3 class="text-sm font-semibold text-blue-300">Funciones Predefinidas</h3>
                            <div class="bg-slate-800 p-4 rounded border border-slate-700 space-y-4">

                                <!-- End Call -->
                                <div
                                    class="flex items-center justify-between p-3 bg-slate-900 rounded border border-slate-700">
                                    <div>
                                        <label class="font-medium text-sm text-slate-200">Habilitar Funci√≥n
                                            "Colgar"</label>
                                        <p class="text-xs text-slate-500">Permite al asistente terminar la llamada
                                            ([END_CALL]).</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" name="enable_end_call" value="true" class="sr-only peer"
                                            {% if config.enable_end_call %}checked{% endif %}>
                                        <div
                                            class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                    </label>
                                </div>

                                <!-- Keypad -->
                                <div
                                    class="flex items-center justify-between p-3 bg-slate-900 rounded border border-slate-700">
                                    <div>
                                        <label class="font-medium text-sm text-slate-200">Habilitar Teclado
                                            Num√©rico</label>
                                        <p class="text-xs text-slate-500">Permite marcar extensiones o n√∫meros
                                            ([DTMF:123]).</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" name="enable_dial_keypad" value="true"
                                            class="sr-only peer" {% if config.enable_dial_keypad %}checked{% endif %}>
                                        <div
                                            class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                    </label>
                                </div>

                                <!-- Transfer -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">N√∫mero para Transferencia</label>
                                    <input type="text" name="transfer_phone_number" placeholder="+52..."
                                        value="{{ config.transfer_phone_number or '' }}"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 font-mono text-sm">
                                    <p class="text-xs text-slate-500 mt-1">Si est√° vac√≠o, la funci√≥n [TRANSFER] no har√°
                                        nada.</p>
                                </div>
                            </div>
                        </div>
                        <!-- üîí END LOCKED SECTION -->

                        <!-- END FROZEN CONFIG -->

                        <!-- Tab: Advanced -->
                        <!-- üîí LOCKED SECTION: PANEL AVANZADO (RESTORED PER REQUEST) -->
                        <div x-show="tab === 'advanced'" class="space-y-4" style="display: none;">
                            <h3 class="text-sm font-semibold text-blue-300">Control de Flujo (Heredado)</h3>

                            <div class="bg-slate-800 p-3 rounded border border-slate-700 mb-4">
                                <p class="text-xs text-slate-400 mb-2">Estos controles intervienen en la llamada para
                                    verificar continuidad.</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Tiempo Espera Inactividad
                                            (s)</label>
                                        <input type="number" name="idle_timeout" step="0.5"
                                            value="{{ config.idle_timeout }}"
                                            class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Intentos M√°ximos
                                            (Silencio)</label>
                                        <input type="number" name="inactivity_max_retries"
                                            value="{{ config.inactivity_max_retries or 3 }}"
                                            class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1">
                                        <p class="text-[10px] text-slate-500 mt-1">Cuelga tras X intentos fallidos.</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mt-2">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Duraci√≥n M√°x Global (s)</label>
                                        <input type="number" name="max_duration" value="{{ config.max_duration }}"
                                            class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Mensaje de Inactividad</label>
                                <input type="text" name="idle_message" value="{{ config.idle_message }}"
                                    class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1">
                            </div>
                        </div>
                        <!-- üîí END LOCKED SECTION -->
                        <!-- Tab: History -->
                        <!-- üîí LOCKED SECTION: PANEL HISTORIAL (DO NOT EDIT WITHOUT AUTH) -->
                        <div x-show="tab === 'history'" class="space-y-4" style="display: none;">
                            <!-- Toolbar -->
                            <div x-show="tab === 'history'" class="space-y-4" style="display: none;">
                                <div id="history-panel" hx-get="/dashboard/history-rows"
                                    hx-trigger="load, refreshHistory from:body" hx-target="this">
                                    <div class="p-8 text-center text-slate-500">
                                        <span
                                            class="inline-block animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-emerald-500 mr-2"></span>
                                        Cargando interfaz de historial...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <script>
                            function toggleAllHistory(source) {
                                const checkboxes = document.querySelectorAll('.history-checkbox');
                                checkboxes.forEach(cb => cb.checked = source.checked);
                                updateDeleteButton();
                            }

                            function updateDeleteButton() {
                                const checked = document.querySelectorAll('.history-checkbox:checked').length;
                                const btn = document.getElementById('btn-delete-selected');
                                if (checked > 0) {
                                    btn.style.display = 'inline-flex';
                                    btn.innerHTML = `<span>üóëÔ∏è</span> Borrar (${checked})`;
                                } else {
                                    btn.style.display = 'none';
                                }
                            }

                            async function deleteSelectedCalls() {
                                if (!confirm('¬øBorrar llamadas seleccionadas?')) return;

                                const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
                                const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

                                try {
                                    const res = await fetch('/api/history/delete-selected', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ call_ids: ids })
                                    });

                                    if (res.ok) {
                                        htmx.trigger('#history-body', 'refreshHistory');
                                        document.querySelector('thead input[type="checkbox"]').checked = false;
                                        updateDeleteButton();
                                    } else {
                                        alert('Error al borrar');
                                    }
                                } catch (e) {
                                    console.error(e);
                                    alert('Error de conexi√≥n');
                                }
                            }
                        </script>
                        <!-- üîí END LOCKED SECTION -->


                </div>
                <!-- END HIDDEN CONFIGURATION SECTION -->

                <div class="pt-4 border-t border-slate-700">
                    <button type="button" onclick="saveConfig()"
                        class="w-full bg-gradient-to-r from-blue-600 to-emerald-600 hover:from-blue-500 hover:to-emerald-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition hover:scale-[1.02] flex items-center justify-center gap-2">
                        <span>üíæ</span> Guardar Configuraci√≥n Completa
                    </button>
                </div>
                </form>

                <script>
                    async function saveConfig() {
                        const btn = document.querySelector('button[onclick="saveConfig()"]');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<span>‚è≥</span> Guardando...';
                        btn.disabled = true;

                        const form = document.querySelector('form[action="/api/config/update"]');
                        const formData = new FormData(form);

                        try {
                            const response = await fetch('/api/config/update', {
                                method: 'POST',
                                body: formData
                            });

                            if (response.ok) {
                                btn.innerHTML = '<span>‚úÖ</span> ¬°Guardado!';
                                btn.classList.add('bg-green-600');
                                setTimeout(() => {
                                    btn.innerHTML = originalText;
                                    btn.classList.remove('bg-green-600');
                                    btn.disabled = false;
                                }, 2000);

                                // Notify Simulator of potentially new settings (e.g. VAD sliders)
                                if (typeof window.updateSimulatorConfig === 'function') {
                                    // window.updateSimulatorConfig(); // Optional: reload sim config
                                }
                            } else {
                                throw new Error('Error en respuesta');
                            }
                        } catch (e) {
                            console.error(e);
                            btn.innerHTML = '<span>‚ùå</span> Error al Guardar';
                            btn.classList.add('bg-red-600');
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('bg-red-600');
                                btn.disabled = false;
                            }, 3000);
                        }
                    }
                </script>

                <!-- Tab: History -->
                <div x-show="tab === 'history'" class="space-y-4">

                    <!-- Filters -->
                    <div class="flex space-x-2 bg-slate-900/50 rounded-lg p-1 border border-slate-700">
                        <button type="button" @click="historyFilter = 'all'"
                            :class="{'bg-blue-600 text-white': historyFilter === 'all', 'text-slate-400 hover:text-white': historyFilter !== 'all'}"
                            class="px-3 py-1 rounded text-xs font-bold transition-all">Todos</button>
                        <button type="button" @click="historyFilter = 'simulator'"
                            :class="{'bg-blue-600 text-white': historyFilter === 'simulator', 'text-slate-400 hover:text-white': historyFilter !== 'simulator'}"
                            class="px-3 py-1 rounded text-xs font-bold transition-all">Simulador</button>
                        <button type="button" @click="historyFilter = 'twilio'"
                            :class="{'bg-red-600 text-white': historyFilter === 'twilio', 'text-slate-400 hover:text-white': historyFilter !== 'twilio'}"
                            class="px-3 py-1 rounded text-xs font-bold transition-all">Twilio</button>
                        <button type="button" @click="historyFilter = 'telnyx'"
                            :class="{'bg-emerald-600 text-white': historyFilter === 'telnyx', 'text-slate-400 hover:text-white': historyFilter !== 'telnyx'}"
                            class="px-3 py-1 rounded text-xs font-bold transition-all">Telnyx</button>
                    </div>

                    <!-- Table -->
                    <div class="overflow-x-auto rounded border border-slate-700">
                        <table class="w-full text-xs text-left text-slate-400">
                            <thead class="text-xs text-slate-300 uppercase bg-slate-800">
                                <tr>
                                    <th scope="col" class="px-4 py-2">Fecha</th>
                                    <th scope="col" class="px-4 py-2">Fuente</th>
                                    <th scope="col" class="px-4 py-2">Duraci√≥n</th>
                                    <th scope="col" class="px-4 py-2">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for call in history %}
                                <tr class="border-b border-slate-800 hover:bg-slate-800/50"
                                    x-show="historyFilter === 'all' || historyFilter === '{{ call.client_type or 'simulator' }}'">
                                    <td class="px-4 py-2 font-mono">{{ call.start_time.strftime('%Y-%m-%d %H:%M') }}
                                    </td>
                                    <td class="px-4 py-2">
                                        {% if call.client_type == 'telnyx' %}
                                        <span
                                            class="px-2 py-0.5 rounded bg-emerald-900/40 text-emerald-400 border border-emerald-700/50">Telnyx</span>
                                        {% elif call.client_type == 'twilio' %}
                                        <span
                                            class="px-2 py-0.5 rounded bg-red-900/40 text-red-400 border border-red-700/50">Twilio</span>
                                        {% else %}
                                        <span
                                            class="px-2 py-0.5 rounded bg-blue-900/40 text-blue-400 border border-blue-700/50">Simulador</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-2 font-mono">
                                        {% if call.end_time %}
                                        {{ (call.end_time - call.start_time).seconds }}s
                                        {% else %}
                                        <span class="text-yellow-500 animate-pulse">En curso</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-2">
                                        <a href="/call/{{ call.id }}" class="text-blue-400 hover:underline">Ver</a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if not history %}
                                <tr>
                                    <td colspan="4" class="px-4 py-8 text-center text-slate-500 italic">
                                        No hay historial disponible.
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Clear History Action -->
                    <div class="pt-2">
                        <form action="/api/history/clear" method="POST"
                            onsubmit="return confirm('¬øBorrar todo el historial?');">
                            <button type="submit"
                                class="text-xs text-red-500 hover:text-red-400 underline decoration-dotted">
                                üóëÔ∏è Borrar Historial Completo
                            </button>
                        </form>
                    </div>
                </div>

            </div> <!-- End x-data -->
        </div>

        <!-- Simulator Panel (Sticky, Right Side) -->
        <div class="sm:col-span-7 lg:col-span-8 sticky top-6 self-start space-y-4">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-xl flex flex-col min-h-[500px]">
                <div class="flex justify-between items-center mb-6">
                    <script>
                        // Expose Config to Simulator
                        window.simulatorConfig = {
                            backgroundAudio: "{{ config.background_sound }}",
                            backgroundUrl: "{{ config.background_sound_url }}"
                        };
                    </script>
                    <div class="flex flex-col">
                        <h2 class="text-xl font-semibold text-emerald-300 flex items-center gap-2">
                            <span>üß™</span> Simulador
                        </h2>
                        <!-- Client Type Indicator -->
                        <div id="sim-client-wrapper" class="text-[10px] font-mono mt-1 text-slate-400">
                            Perfil: <span id="sim-mode-text" class="text-blue-400 font-bold">Navegador</span>
                        </div>
                    </div>
                    <button id="start-btn" onclick="toggleCall()"
                        class="px-5 py-2 bg-emerald-600 hover:bg-emerald-500 rounded font-bold shadow-lg transition-all text-sm">
                        Iniciar Prueba
                    </button>
                </div>

                <div
                    class="flex-grow bg-slate-900 rounded-lg p-4 border border-slate-600 relative overflow-hidden flex flex-col items-center justify-center min-h-[300px]">
                    <div id="status-indicator" class="text-slate-500 font-mono mb-4 text-lg">Listo para conectar...
                    </div>

                    <!-- Visualizer Canvas -->
                    <canvas id="visualizer" width="600" height="100" class="w-full h-32"></canvas>
                </div>

                <!-- SIMULATOR VAD CONTROLS (HIDDEN) -->
                <div class="mt-4 p-4 bg-slate-900/50 rounded border border-slate-700" style="display:none !important;">
                    <h3 class="text-sm font-mono text-slate-400 mb-2">CONTROLES DE SENSIBILIDAD (VAD)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium mb-1 text-slate-300 flex justify-between">
                                <span>Sensibilidad Mic (RMS)</span>
                                <span id="vad-sens-val" class="text-emerald-400">0.05</span>
                            </label>
                            <input type="range" id="vad-sensitivity" min="0.005" max="0.2" step="0.005" value="0.05"
                                class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                oninput="document.getElementById('vad-sens-val').innerText = this.value">
                            <p class="text-[10px] text-slate-500 mt-1">Actual: <span id="cur-rms"
                                    class="font-mono text-blue-400">0.00</span> | M√≠nimo ruido</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1 text-slate-300 flex justify-between">
                                <span>Umbral de Voz (Frec)</span>
                                <span id="vad-voice-val" class="text-emerald-400">45</span>
                            </label>
                            <input type="range" id="vad-voice-threshold" min="0" max="100" step="5" value="45"
                                class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                oninput="document.getElementById('vad-voice-val').innerText = this.value">
                            <p class="text-[10px] text-slate-500 mt-1">Actual: <span id="cur-voice"
                                    class="font-mono text-blue-400">0</span> | Calidad Voz</p>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <label class="block text-xs font-medium mb-1 text-slate-300 flex justify-between">
                            <span>Filtro de Ruido (Min Letras)</span>
                            <span id="min-chars-val" class="text-orange-400">1</span>
                        </label>
                        <input type="range" id="input-min-chars" min="0" max="50" step="1" value="1"
                            class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                            oninput="document.getElementById('min-chars-val').innerText = this.value; document.getElementById('form-input-min-chars').value = this.value; updateServerConfig('input_min_characters', this.value)">
                        <p class="text-[10px] text-slate-500 mt-1">Ignora textos menores a X letras. (Recomendado:
                            20-30 para ambientes ruidosos)</p>
                    </div>
                </div>

                <!-- Latest Transcript -->
                <div class="mt-4 p-4 bg-slate-900/50 rounded border border-slate-700">
                    <h3 class="text-sm font-mono text-slate-400 mb-2">TRANSCRIPCI√ìN EN VIVO</h3>

                    <div id="transcript-box" class="h-40 overflow-y-auto text-sm space-y-2">
                        <!-- Messages inserted by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="/static/js/simulator.js"></script>
</body>

</html>