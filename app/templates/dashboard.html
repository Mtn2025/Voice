<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orquestador de Voz Nativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fragment+Mono&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        [x-cloak] {
            display: none !important;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .font-mono {
            font-family: 'Fragment Mono', monospace;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .glass-input:focus {
            border-color: #3b82f6;
            background: rgba(15, 23, 42, 0.8);
            outline: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            rounded: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.7);
        }
    </style>
</head>

<body class="min-h-screen bg-slate-900 selection:bg-blue-500/30">

    <!-- SERVER DATA INJECTION (Safe JSON) -->
    <script id="server-config" type="application/json">
        {{ config.dict() | tojson if config.dict is defined else config | tojson }}
    </script>
    <script id="server-voices" type="application/json">{{ voices | tojson }}</script>
    <script id="server-styles" type="application/json">{{ voice_styles | tojson }}</script>
    <script id="server-models" type="application/json">{{ llm_models | tojson }}</script>
    <script id="server-langs" type="application/json">{{ languages | tojson }}</script>

    <!-- Main Container -->
    <div x-data="dashboard()" x-init="init()" x-cloak
        class="max-w-[1800px] mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- HEADER -->
        <div class="lg:col-span-12 flex justify-between items-center mb-2 glass-panel p-4 rounded-xl">
            <div class="flex items-center space-x-4">
                <div class="p-2 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg shadow-lg shadow-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </div>
                <div>
                    <h1
                        class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-300">
                        Orquestador de Voz Nativo
                    </h1>
                    <p class="text-xs text-slate-400 font-mono tracking-wider">PANEL DE CONTROL UNIFICADO</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div
                    class="flex items-center space-x-2 px-3 py-1.5 bg-green-500/10 border border-green-500/20 rounded-full">
                    <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="text-xs font-medium text-green-400">En L√≠nea</span>
                </div>
            </div>
        </div>

        <!-- LEFT COLUMN: CONFIGURATION (5/12) -->
        <div class="lg:col-span-5 space-y-6">

            <form action="/api/config/update" method="POST" id="configForm" @submit.prevent="saveConfig">
                <!-- PROFILE SELECTOR (Tabs) -->
                <div class="glass-panel p-2 rounded-xl flex space-x-1 mb-6">
                    <button type="button" @click="activeProfile = 'browser'"
                        :class="{'bg-blue-600 text-white shadow-lg shadow-blue-500/25': activeProfile === 'browser', 'text-slate-400 hover:text-white hover:bg-white/5': activeProfile !== 'browser'}"
                        class="flex-1 py-2 rounded-lg text-sm font-medium transition-all flex justify-center items-center space-x-2">
                        <span>üåê Simulador</span>
                    </button>
                    <button type="button" @click="activeProfile = 'twilio'"
                        :class="{'bg-red-600 text-white shadow-lg shadow-red-500/25': activeProfile === 'twilio', 'text-slate-400 hover:text-white hover:bg-white/5': activeProfile !== 'twilio'}"
                        class="flex-1 py-2 rounded-lg text-sm font-medium transition-all flex justify-center items-center space-x-2">
                        <span>üì± Twilio</span>
                    </button>
                    <button type="button" @click="activeProfile = 'telnyx'"
                        :class="{'bg-emerald-600 text-white shadow-lg shadow-emerald-500/25': activeProfile === 'telnyx', 'text-slate-400 hover:text-white hover:bg-white/5': activeProfile !== 'telnyx'}"
                        class="flex-1 py-2 rounded-lg text-sm font-medium transition-all flex justify-center items-center space-x-2">
                        <span>ü¶ï Telnyx</span>
                    </button>
                </div>

                <!-- MAIN CONFIG PANEL -->
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden min-h-[600px] pb-24">
                    <!-- Settings Tabs -->
                    <div class="flex space-x-6 border-b border-slate-700/50 pb-4 mb-6 overflow-x-auto">
                        <template x-for="t in ['Model', 'Voz', 'Transcriptor', 'Avanzado', 'Historial', 'Conexi√≥n']">
                            <button type="button" @click="activeTab = t.toLowerCase()" x-show="shouldShowTab(t)"
                                :class="{'text-blue-400 border-b-2 border-blue-400': activeTab === t.toLowerCase(), 'text-slate-400 hover:text-white': activeTab !== t.toLowerCase()}"
                                class="pb-2 text-sm font-medium whitespace-nowrap transition-colors" x-text="t">
                            </button>
                        </template>
                    </div>

                    <!-- TAB START: MODEL -->
                    <div x-show="activeTab === 'model'" class="space-y-5 animate-fade-in-up">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Proveedor
                                    LLM</label>
                                <select x-model="c.provider" @change="updateModelList()"
                                    class="glass-input w-full p-2.5 rounded-lg text-sm">
                                    <option value="groq">Groq</option>
                                    <option value="azure">Azure OpenAI</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Modelo</label>
                                <select x-model="c.model" class="glass-input w-full p-2.5 rounded-lg text-sm">
                                    <template x-for="m in availableModels">
                                        <option :value="m.id" x-text="m.id"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block flex justify-between">
                                <span>Temperatura</span>
                                <span class="text-blue-400" x-text="c.temp"></span>
                            </label>
                            <input type="range" x-model="c.temp" min="0" max="1" step="0.1"
                                class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                            <p class="text-[10px] text-slate-500 mt-1">Creatividad vs Determinismo (0.0 = Preciso, 1.0 =
                                Creativo)</p>
                        </div>

                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block flex justify-between">
                                <span>Max Tokens</span>
                                <span class="text-blue-400" x-text="c.tokens"></span>
                            </label>
                            <input type="number" x-model="c.tokens" class="glass-input w-full p-2.5 rounded-lg text-sm">
                            <p class="text-[10px] text-slate-500 mt-1">Longitud m√°xima de la respuesta (Tokens).</p>
                        </div>

                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">System
                                Prompt</label>
                            <textarea x-model="c.prompt" rows="6"
                                class="glass-input w-full p-3 rounded-lg text-sm font-mono leading-relaxed"
                                placeholder="Instrucciones para el agente..."></textarea>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Mensaje
                                    Inicial</label>
                                <input type="text" x-model="c.msg" class="glass-input w-full p-2.5 rounded-lg text-sm">
                            </div>
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Modo
                                    Inicio</label>
                                <select x-model="c.mode"
                                    class="glass-input w-full p-2.5 rounded-lg text-sm bg-slate-800">
                                    <option value="speak-first">Hablar Primero (Agente)</option>
                                    <option value="listen-first">Escuchar Primero (Usuario)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- TAB START: VOZ -->
                    <div x-show="activeTab === 'voz'" class="space-y-5 animate-fade-in-up">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Proveedor
                                    TTS</label>
                                <select x-model="c.voiceProvider" @change="updateVoiceLists()"
                                    class="glass-input w-full p-2.5 rounded-lg text-sm">
                                    <option value="azure">Azure</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Idioma</label>
                                <select x-model="c.voiceLang" @change="updateVoiceLists()"
                                    class="glass-input w-full p-2.5 rounded-lg text-sm">
                                    <template x-for="l in availableLanguages">
                                        <option :value="l.id" x-text="l.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Gender Filter -->
                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">G√©nero</label>
                            <div class="flex space-x-2">
                                <template x-for="g in availableGenders">
                                    <button type="button" @click="setGender(g.id)"
                                        :class="{'bg-blue-600 border-blue-500 text-white': currentGender === g.id, 'bg-slate-800 border-slate-700 text-slate-400': currentGender !== g.id}"
                                        class="px-3 py-1.5 rounded-md text-xs font-medium border transition-colors capitalize"
                                        x-text="g.name">
                                    </button>
                                </template>
                            </div>
                        </div>

                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Voz</label>
                            <select x-model="c.voiceId" @change="updateStyleList()"
                                class="glass-input w-full p-2.5 rounded-lg text-sm">
                                <template x-for="v in availableVoices">
                                    <option :value="v.id" x-text="v.name"></option>
                                </template>
                            </select>
                        </div>

                        <div x-show="availableStyles.length > 0">
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Estilo
                                Emocional</label>
                            <select x-model="c.voiceStyle" class="glass-input w-full p-2.5 rounded-lg text-sm">
                                <option value="">(Default)</option>
                                <template x-for="s in availableStyles">
                                    <option :value="s.id" x-text="s.label"></option>
                                </template>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block flex justify-between">
                                    <span>Velocidad</span>
                                    <span class="text-blue-400" x-text="c.voiceSpeed"></span>
                                </label>
                                <input type="range" x-model="c.voiceSpeed" min="0.5" max="2.0" step="0.1"
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                <p class="text-[10px] text-slate-500 mt-1">Factor de velocidad (0.5 = Lento, 1.0 =
                                    Normal, 2.0 = R√°pido)</p>
                            </div>
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block flex justify-between">
                                    <span>Pausa Inicial (ms)</span>
                                    <span class="text-blue-400" x-text="c.voicePacing"></span>
                                </label>
                                <input type="range" x-model="c.voicePacing" min="0" max="2000" step="100"
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                <p class="text-[10px] text-slate-500 mt-1">Tiempo de espera antes de hablar (evita
                                    interrupciones)</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Sonido
                                    de Fondo</label>
                                <select x-model="c.voiceBgSound" class="glass-input w-full p-2.5 rounded-lg text-sm">
                                    <option value="none">üîá Silencio</option>
                                    <option value="office">üè¢ Oficina</option>
                                    <option value="cafe">‚òï Cafeter√≠a</option>
                                    <option value="callcenter">üìû Call Center</option>
                                    <option value="custom">üîó URL Personalizada</option>
                                </select>
                            </div>
                            <div x-show="c.voiceBgSound === 'custom'">
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">URL
                                    Audio</label>
                                <input type="text" x-model="c.voiceBgUrl"
                                    class="glass-input w-full p-2.5 rounded-lg text-sm" placeholder="https://...">
                            </div>
                        </div>

                    </div>

                    <!-- TAB START: TRANSCRIPTOR -->
                    <div x-show="activeTab === 'transcriptor'" class="space-y-5 animate-fade-in-up">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Proveedor
                                    STT</label>
                                <select x-model="c.sttProvider" class="glass-input w-full p-2.5 rounded-lg text-sm">
                                    <template x-for="p in ['azure']">
                                        <option :value="p" x-text="p.charAt(0).toUpperCase() + p.slice(1)"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Idioma</label>
                                <select x-model="c.sttLang" class="glass-input w-full p-2.5 rounded-lg text-sm">
                                    <template x-for="l in availableLanguages">
                                        <option :value="l.id" x-text="l.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <div class="p-4 rounded-lg border border-slate-700 bg-slate-800/50">
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4 block">Control
                                de Interrupciones</label>

                            <div class="mb-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm">Umbral de Palabras</span>
                                    <span class="text-blue-400 font-mono" x-text="c.interruptWords"></span>
                                </div>
                                <input type="range" x-model="c.interruptWords" min="0" max="10" step="1"
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                <p class="text-[10px] text-slate-500 mt-1">Palabras requeridas para detener al bot.</p>
                            </div>

                            <div x-show="activeProfile === 'telnyx'">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm">Sensibilidad (RMS)</span>
                                    <span class="text-blue-400 font-mono" x-text="c.interruptRMS"></span>
                                </div>
                                <input type="range" x-model="c.interruptRMS" min="0" max="10000" step="100"
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                                <p class="text-[10px] text-slate-500 mt-1">Nivel de audio para detectar voz humana.</p>
                            </div>
                        </div>

                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block flex justify-between">
                                <span>Timeout Silencio (ms)</span>
                                <span class="text-blue-400" x-text="c.silence"></span>
                            </label>
                            <input type="range" x-model="c.silence" min="100" max="5000" step="100"
                                class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>

                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Blacklist
                                Alucinaciones</label>
                            <input type="text" x-model="c.blacklist"
                                class="glass-input w-full p-2.5 rounded-lg text-sm">
                        </div>

                        <div class="flex items-center space-x-4 pt-2">
                            <div>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" x-model="c.denoise"
                                        class="form-checkbox bg-slate-800 border-slate-600 text-blue-500 rounded">
                                    <span class="text-sm">Denoising</span>
                                </label>
                                <p class="text-[10px] text-slate-500 mt-1 ml-6">Filtra ruido de fondo del micr√≥fono para
                                    mejorar transcripci√≥n.</p>
                            </div>
                            <label class="flex items-center space-x-2 cursor-pointer"
                                x-show="activeProfile === 'telnyx'">
                                <input type="checkbox" x-model="c.krisp"
                                    class="form-checkbox bg-slate-800 border-slate-600 text-emerald-500 rounded">
                                <span class="text-sm">Krisp AI</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer"
                                x-show="activeProfile === 'telnyx'">
                                <input type="checkbox" x-model="c.vad"
                                    class="form-checkbox bg-slate-800 border-slate-600 text-emerald-500 rounded">
                                <span class="text-sm">VAD</span>
                            </label>
                        </div>
                    </div>


                    <!-- TAB START: AVANZADO -->
                    <div x-show="activeTab === 'avanzado'" class="space-y-5 animate-fade-in-up">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Duraci√≥n
                                    M√°x (seg)</label>
                                <input type="number" x-model="c.maxDuration"
                                    class="glass-input w-full p-2.5 rounded-lg text-sm">
                            </div>
                            <div>
                                <label
                                    class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Max
                                    Retries</label>
                                <input type="number" x-model="c.maxRetries"
                                    class="glass-input w-full p-2.5 rounded-lg text-sm">
                            </div>
                        </div>

                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block flex justify-between">
                                <span>Timeout Inactividad (seg)</span>
                                <span class="text-blue-400" x-text="c.idleTimeout"></span>
                            </label>
                            <input type="range" x-model="c.idleTimeout" min="5" max="60" step="1"
                                class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>

                        <div>
                            <label
                                class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Mensaje
                                Inactividad</label>
                            <input type="text" x-model="c.idleMessage"
                                class="glass-input w-full p-2.5 rounded-lg text-sm">
                        </div>

                        <div x-show="activeProfile === 'telnyx'" class="pt-4 border-t border-slate-700">
                            <h4 class="text-xs font-bold text-emerald-400 uppercase mb-3">Telnyx Only</h4>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" x-model="c.enableRecording"
                                        class="form-checkbox bg-slate-800 border-slate-600 text-emerald-500 rounded">
                                    <span class="text-sm">Grabar Llamada</span>
                                </label>
                                <div>
                                    <label class="text-xs text-slate-400 block mb-1">AMD Config</label>
                                    <select x-model="c.amdConfig" class="glass-input w-full p-2.5 rounded-lg text-sm">
                                        <option value="disabled">Disabled</option>
                                        <option value="premium">Premium</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB START: HISTORIAL -->
                    <div x-show="activeTab === 'historial'" class="space-y-4 animate-fade-in-up">
                        <!-- Filters -->
                        <div class="flex space-x-2 bg-slate-900/50 rounded-lg p-1 border border-slate-700">
                            <button type="button" @click="activeHistoryFilter = 'all'"
                                :class="{'bg-blue-600 text-white': activeHistoryFilter === 'all', 'text-slate-400 hover:text-white': activeHistoryFilter !== 'all'}"
                                class="px-3 py-1 rounded text-xs font-bold transition-all">Todos</button>
                            <button type="button" @click="activeHistoryFilter = 'simulator'"
                                :class="{'bg-blue-600 text-white': activeHistoryFilter === 'simulator', 'text-slate-400 hover:text-white': activeHistoryFilter !== 'simulator'}"
                                class="px-3 py-1 rounded text-xs font-bold transition-all">Simulador</button>
                            <button type="button" @click="activeHistoryFilter = 'twilio'"
                                :class="{'bg-red-600 text-white': activeHistoryFilter === 'twilio', 'text-slate-400 hover:text-white': activeHistoryFilter !== 'twilio'}"
                                class="px-3 py-1 rounded text-xs font-bold transition-all">Twilio</button>
                            <button type="button" @click="activeHistoryFilter = 'telnyx'"
                                :class="{'bg-emerald-600 text-white': activeHistoryFilter === 'telnyx', 'text-slate-400 hover:text-white': activeHistoryFilter !== 'telnyx'}"
                                class="px-3 py-1 rounded text-xs font-bold transition-all">Telnyx</button>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto rounded border border-slate-700">
                            <table class="w-full text-xs text-left text-slate-400">
                                <thead class="text-xs text-slate-300 uppercase bg-slate-800">
                                    <tr>
                                        <!-- Checkbox for Bulk Actions -->
                                        <th scope="col" class="px-4 py-2 w-8">
                                            <input type="checkbox" onclick="toggleAllHistory(this)"
                                                class="rounded bg-slate-700 border-slate-600 text-blue-600 focus:ring-blue-600 ring-offset-slate-800 focus:ring-2">
                                        </th>
                                        <th scope="col" class="px-4 py-2">Fecha</th>
                                        <th scope="col" class="px-4 py-2">Fuente</th>
                                        <th scope="col" class="px-4 py-2">Duraci√≥n</th>
                                        <th scope="col" class="px-4 py-2">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="history-body" hx-get="/api/history/rows"
                                    hx-trigger="refreshHistory from:body">
                                    {% for call in history %}
                                    <tr class="border-b border-slate-800 hover:bg-slate-800/50"
                                        x-show="activeHistoryFilter === 'all' || activeHistoryFilter === '{{ call.client_type or 'simulator' }}'">
                                        <td class="px-4 py-2">
                                            <input type="checkbox" value="{{ call.id }}"
                                                class="history-checkbox rounded bg-slate-700 border-slate-600 text-blue-600 focus:ring-blue-600 ring-offset-slate-800 focus:ring-2"
                                                onchange="updateDeleteButton()">
                                        </td>
                                        <td class="px-4 py-2 font-mono">{{ call.start_time.strftime('%Y-%m-%d %H:%M') }}
                                        </td>
                                        <td class="px-4 py-2">
                                            {% if call.client_type == 'telnyx' %}
                                            <span
                                                class="px-2 py-0.5 rounded bg-emerald-900/40 text-emerald-400 border border-emerald-700/50">Telnyx</span>
                                            {% elif call.client_type == 'twilio' %}
                                            <span
                                                class="px-2 py-0.5 rounded bg-red-900/40 text-red-400 border border-red-700/50">Twilio</span>
                                            {% else %}
                                            <span
                                                class="px-2 py-0.5 rounded bg-blue-900/40 text-blue-400 border border-blue-700/50">Simulador</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-2 font-mono">
                                            {% if call.end_time %}
                                            {{ (call.end_time - call.start_time).seconds }}s
                                            {% else %}
                                            <span class="text-yellow-500 animate-pulse">En curso</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-2">
                                            <a href="/dashboard/call/{{ call.id }}?api_key={{ request.query_params.get('api_key', '') }}"
                                                class="text-blue-400 hover:underline">Ver</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% if not history %}
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-slate-500 italic">
                                            No hay historial disponible.
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Bulk Actions Footer -->
                        <div class="pt-2 flex justify-between items-center">
                            <button id="btn-delete-selected" onclick="deleteSelectedCalls()" style="display: none;"
                                class="text-xs bg-red-900/30 text-red-400 px-3 py-1 rounded border border-red-800 hover:bg-red-900/50 transition-all items-center space-x-1">
                                <span>üóëÔ∏è</span> Borrar Seleccionados
                            </button>

                            <form action="/api/history/clear?api_key={{ request.query_params.get('api_key', '') }}"
                                method="POST" onsubmit="return confirm('¬øBorrar todo el historial?');">
                                <button type="submit"
                                    class="text-xs text-red-500 hover:text-red-400 underline decoration-dotted">
                                    üóëÔ∏è Borrar Historial Completo
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- This ensures backend receives expected fields regardless of active tab -->
                    <div class="hidden">
                        <!-- Browser/Common -->
                        <input type="hidden" name="llm_provider" :value="configs.browser.provider">
                        <input type="hidden" name="llm_model" :value="configs.browser.model">
                        <input type="hidden" name="temperature" :value="configs.browser.temp">
                        <input type="hidden" name="max_tokens" :value="configs.browser.tokens">
                        <input type="hidden" name="system_prompt" :value="configs.browser.prompt">
                        <input type="hidden" name="first_message" :value="configs.browser.msg">
                        <input type="hidden" name="first_message_mode" :value="configs.browser.mode">

                        <input type="hidden" name="tts_provider" :value="configs.browser.voiceProvider">
                        <input type="hidden" name="voice_name" :value="configs.browser.voiceId">
                        <input type="hidden" name="voice_style" :value="configs.browser.voiceStyle">
                        <input type="hidden" name="voice_speed" :value="configs.browser.voiceSpeed">
                        <input type="hidden" name="voice_pacing_ms" :value="configs.browser.voicePacing">
                        <input type="hidden" name="background_sound" :value="configs.browser.voiceBgSound">
                        <input type="hidden" name="background_sound_url" :value="configs.browser.voiceBgUrl">

                        <input type="hidden" name="stt_provider" :value="configs.browser.sttProvider">
                        <input type="hidden" name="stt_language" :value="configs.browser.sttLang">
                        <input type="hidden" name="interruption_threshold" :value="configs.browser.interruptWords">
                        <input type="hidden" name="silence_timeout_ms" :value="configs.browser.silence">
                        <input type="hidden" name="hallucination_blacklist" :value="configs.browser.blacklist">

                        <input type="hidden" name="enable_end_call" :value="configs.browser.enableEndCall">
                        <input type="hidden" name="enable_dial_keypad" :value="configs.browser.dialKeypad">
                        <input type="hidden" name="transfer_phone_number" :value="configs.browser.transferNum">

                        <input type="hidden" name="idle_timeout" :value="configs.browser.idleTimeout">
                        <input type="hidden" name="max_duration" :value="configs.browser.maxDuration">
                        <input type="hidden" name="idle_message" :value="configs.browser.idleMessage">
                        <input type="hidden" name="inactivity_max_retries" :value="configs.browser.maxRetries">

                        <!-- Twilio -->
                        <input type="hidden" name="llm_provider_phone" :value="configs.twilio.provider">
                        <input type="hidden" name="llm_model_phone" :value="configs.twilio.model">
                        <input type="hidden" name="temperature_phone" :value="configs.twilio.temp">
                        <input type="hidden" name="max_tokens_phone" :value="configs.twilio.tokens">
                        <input type="hidden" name="system_prompt_phone" :value="configs.twilio.prompt">
                        <input type="hidden" name="first_message_phone" :value="configs.twilio.msg">
                        <input type="hidden" name="first_message_mode_phone" :value="configs.twilio.mode">

                        <input type="hidden" name="tts_provider_phone" :value="configs.twilio.voiceProvider">
                        <input type="hidden" name="voice_name_phone" :value="configs.twilio.voiceId">
                        <input type="hidden" name="voice_style_phone" :value="configs.twilio.voiceStyle">
                        <input type="hidden" name="voice_speed_phone" :value="configs.twilio.voiceSpeed">
                        <input type="hidden" name="voice_pacing_ms_phone" :value="configs.twilio.voicePacing">
                        <input type="hidden" name="background_sound_phone" :value="configs.twilio.voiceBgSound">

                        <input type="hidden" name="stt_provider_phone" :value="configs.twilio.sttProvider">
                        <input type="hidden" name="stt_language_phone" :value="configs.twilio.sttLang">
                        <input type="hidden" name="interruption_threshold_phone" :value="configs.twilio.interruptWords">
                        <input type="hidden" name="silence_timeout_ms_phone" :value="configs.twilio.silence">
                        <input type="hidden" name="input_min_characters_phone" :value="configs.twilio.inputMin">
                        <input type="hidden" name="hallucination_blacklist_phone" :value="configs.twilio.blacklist">
                        <input type="hidden" name="enable_denoising_phone" :value="configs.twilio.denoise">

                        <!-- Telnyx -->
                        <input type="hidden" name="llm_provider_telnyx" :value="configs.telnyx.provider">
                        <input type="hidden" name="llm_model_telnyx" :value="configs.telnyx.model">
                        <input type="hidden" name="temperature_telnyx" :value="configs.telnyx.temp">
                        <input type="hidden" name="max_tokens_telnyx" :value="configs.telnyx.tokens">
                        <input type="hidden" name="system_prompt_telnyx" :value="configs.telnyx.prompt">
                        <input type="hidden" name="first_message_telnyx" :value="configs.telnyx.msg">
                        <input type="hidden" name="first_message_mode_telnyx" :value="configs.telnyx.mode">

                        <input type="hidden" name="tts_provider_telnyx" :value="configs.telnyx.voiceProvider">
                        <input type="hidden" name="voice_name_telnyx" :value="configs.telnyx.voiceId">
                        <input type="hidden" name="voice_style_telnyx" :value="configs.telnyx.voiceStyle">
                        <input type="hidden" name="voice_speed_telnyx" :value="configs.telnyx.voiceSpeed">
                        <input type="hidden" name="voice_pacing_ms_telnyx" :value="configs.telnyx.voicePacing">
                        <input type="hidden" name="background_sound_telnyx" :value="configs.telnyx.voiceBgSound">
                        <input type="hidden" name="background_sound_url_telnyx" :value="configs.telnyx.voiceBgUrl">

                        <input type="hidden" name="stt_provider_telnyx" :value="configs.telnyx.sttProvider">
                        <input type="hidden" name="stt_language_telnyx" :value="configs.telnyx.sttLang">
                        <input type="hidden" name="interruption_threshold_telnyx"
                            :value="configs.telnyx.interruptWords">
                        <input type="hidden" name="voice_sensitivity_telnyx" :value="configs.telnyx.interruptRMS">
                        <input type="hidden" name="silence_timeout_ms_telnyx" :value="configs.telnyx.silence">
                        <input type="hidden" name="input_min_characters_telnyx" :value="configs.telnyx.inputMin">
                        <input type="hidden" name="hallucination_blacklist_telnyx" :value="configs.telnyx.blacklist">
                        <input type="hidden" name="enable_denoising_telnyx" :value="configs.telnyx.denoise">
                        <input type="hidden" name="enable_krisp_telnyx" :value="configs.telnyx.krisp">
                        <input type="hidden" name="enable_vad_telnyx" :value="configs.telnyx.vad">

                        <input type="hidden" name="idle_timeout_telnyx" :value="configs.telnyx.idleTimeout">
                        <input type="hidden" name="max_duration_telnyx" :value="configs.telnyx.maxDuration">
                        <input type="hidden" name="idle_message_telnyx" :value="configs.telnyx.idleMessage">
                        <input type="hidden" name="enable_recording_telnyx" :value="configs.telnyx.enableRecording">
                        <input type="hidden" name="amd_config_telnyx" :value="configs.telnyx.amdConfig">
                    </div>

                    <!-- FOOTER ACTIONS -->
                    <div x-show="activeTab !== 'historial'"
                        class="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-700/50 flex justify-end bg-slate-900/50 backdrop-blur-sm">
                        <button type="submit"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg text-sm font-semibold shadow-lg shadow-blue-500/20 transition-all flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            <span>Guardar Cambios</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- RIGHT COLUMN: SIMULATOR (7/12) -->
        <div class="lg:col-span-7 space-y-6">
            <div class="sticky top-6">
                <!-- SIMULATOR HEADER -->
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="text-xl">üß™</span>
                        <h2 class="text-lg font-semibold text-emerald-400">Simulador</h2>
                    </div>
                    <button @click="startTest()"
                        :class="{'bg-red-600 hover:bg-red-500': simState === 'connected', 'bg-emerald-600 hover:bg-emerald-500': simState !== 'connected'}"
                        class="text-white px-4 py-1.5 rounded-lg text-sm font-medium shadow-lg shadow-emerald-500/20 transition-all border border-white/10"
                        x-text="simState === 'connected' ? 'Detener' : (simState === 'connecting' ? 'Conectando...' : 'Iniciar Prueba')">
                    </button>
                </div>

                <!-- VISUALIZER AREA -->
                <div
                    class="glass-panel h-[400px] rounded-xl flex items-center justify-center p-6 mb-4 relative overflow-hidden bg-black/40">
                    <p class="text-mono text-emerald-500/50" :class="{'animate-pulse': simState === 'connecting'}"
                        x-text="simState === 'connected' ? 'En L√≠nea' : (simState === 'connecting' ? 'Conectando...' : 'Listo para conectar...')">
                    </p>
                </div>

                <!-- TRANSCRIPT -->
                <div
                    class="glass-panel h-[200px] rounded-xl p-4 overflow-y-auto font-mono text-xs border border-slate-700/50">
                    <div class="text-slate-500 mb-2">TRANSCRIPCI√ìN EN VIVO</div>
                </div>
            </div>
        </div>

    </div>

    <!-- APP LOGIC -->
    <script>
        // --- HISTORY TAB HELPERS ---
        function toggleAllHistory(source) {
            const checkboxes = document.querySelectorAll('.history-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checked = document.querySelectorAll('.history-checkbox:checked').length;
            const btn = document.getElementById('btn-delete-selected');
            if (btn) {
                if (checked > 0) {
                    btn.style.display = 'inline-flex';
                    btn.innerHTML = `<span>üóëÔ∏è</span> Borrar (${checked})`;
                } else {
                    btn.style.display = 'none';
                }
            }
        }

        async function deleteSelectedCalls() {
            if (!confirm('¬øBorrar llamadas seleccionadas?')) return;

            const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
            const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

            // Fix Auth: Get API Key from URL
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('api_key') || '';

            try {
                const res = await fetch(`/api/history/delete-selected?api_key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ call_ids: ids })
                });

                if (res.ok) {
                    // Refresh page or trigger HTMX if endpoints exist
                    window.location.reload();
                } else {
                    alert('Error al borrar');
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexi√≥n');
            }
        }

        function dashboard() {
            return {
                activeTab: 'model',
                activeHistoryFilter: 'all',
                activeProfile: 'browser',
                serverConfig: {},

                // DATA HOLDERS
                configs: { browser: {}, twilio: {}, telnyx: {} },

                // CATALAGS
                voices: [],
                styles: [],
                models: [],
                languages: [],

                // UI COMPUTED LISTS
                availableModels: [],
                availableLanguages: [],
                availableVoices: [],
                availableStyles: [],
                availableGenders: [],
                currentGender: 'female',

                // CURRENT CONFIG POINTER (Convenience accessor for UI binding)
                get c() { return this.configs[this.activeProfile]; },

                async init() {
                    // 1. SAFELY PARSE SERVER DATA
                    try {
                        this.serverConfig = JSON.parse(document.getElementById('server-config').textContent);
                        this.voices = JSON.parse(document.getElementById('server-voices').textContent);
                        this.styles = JSON.parse(document.getElementById('server-styles').textContent);
                        this.models = JSON.parse(document.getElementById('server-models').textContent);
                        this.languages = JSON.parse(document.getElementById('server-langs').textContent);
                    } catch (e) {
                        console.error("CRITICAL: JSON Parsing failed", e);
                        return; // Stop execution if critical data missing
                    }

                    // 2. INITIALIZE CONFIG STORE FROM SERVER DATA
                    this.initBrowserConfig();
                    this.initTwilioConfig();
                    this.initTelnyxConfig();

                    // 3. SETUP WATCHERS & INITIAL UI LISTS
                    this.$watch('activeProfile', () => this.refreshUI());
                    this.refreshUI();
                },

                initBrowserConfig() {
                    const s = this.serverConfig;
                    this.configs.browser = {
                        provider: s.llm_provider || 'openai',
                        model: s.llm_model || 'gpt-3.5-turbo',
                        temp: s.temperature || 0.7,
                        tokens: s.max_tokens || 250,
                        msg: s.first_message || '',
                        mode: s.first_message_mode || 'speak-first',
                        prompt: s.system_prompt || '',

                        voiceProvider: s.tts_provider || 'azure',
                        voiceLang: s.voice_language || 'es-MX',
                        voiceId: s.voice_name || '',
                        voiceStyle: s.voice_style || '',
                        voiceSpeed: s.voice_speed || 1.0,
                        voicePacing: s.voice_pacing_ms || 0,
                        voiceBgSound: s.background_sound || 'none',
                        voiceBgUrl: s.background_sound_url || '',

                        sttProvider: s.stt_provider || 'azure',
                        sttLang: s.stt_language || 'es-MX',
                        interruptWords: s.interruption_threshold || 0,
                        silence: s.silence_timeout_ms || 5000,
                        blacklist: s.hallucination_blacklist || '',

                        enableEndCall: s.enable_end_call,
                        dialKeypad: s.enable_dial_keypad,
                        transferNum: s.transfer_phone_number,

                        idleTimeout: s.idle_timeout || 10,
                        maxDuration: s.max_duration || 600,
                        idleMessage: s.idle_message || '',
                        maxRetries: s.inactivity_max_retries || 3
                    };
                },

                initTwilioConfig() {
                    const s = this.serverConfig;
                    this.configs.twilio = {
                        provider: s.llm_provider_phone || s.llm_provider || 'openai',
                        model: s.llm_model_phone || s.llm_model || 'gpt-3.5-turbo',
                        temp: s.temperature_phone || s.temperature || 0.7,
                        tokens: s.max_tokens_phone || s.max_tokens || 250,
                        msg: s.first_message_phone || s.first_message || '',
                        mode: s.first_message_mode_phone || s.first_message_mode || 'speak-first',
                        prompt: s.system_prompt_phone || '',

                        voiceProvider: s.tts_provider_phone || s.tts_provider || 'azure',
                        voiceLang: s.voice_language_phone || 'es-MX',
                        voiceId: s.voice_name_phone || '',
                        voiceStyle: s.voice_style_phone || '',
                        voiceSpeed: s.voice_speed_phone || 1.0,
                        voicePacing: s.voice_pacing_ms_phone || 0,
                        voiceBgSound: s.background_sound_phone || 'none',

                        sttProvider: s.stt_provider_phone || 'azure',
                        sttLang: s.stt_language_phone || 'es-MX',
                        interruptWords: s.interruption_threshold_phone || 0,
                        silence: s.silence_timeout_ms_phone || 5000,
                        inputMin: s.input_min_characters_phone || 0,
                        blacklist: s.hallucination_blacklist_phone || '',
                        denoise: s.enable_denoising_phone || false
                    };
                },

                initTelnyxConfig() {
                    const s = this.serverConfig;
                    this.configs.telnyx = {
                        provider: s.llm_provider_telnyx || s.llm_provider || 'openai',
                        model: s.llm_model_telnyx || s.llm_model || 'gpt-3.5-turbo',
                        temp: s.temperature_telnyx || s.temperature || 0.7,
                        tokens: s.max_tokens_telnyx || s.max_tokens || 250,
                        msg: s.first_message_telnyx || s.first_message || '',
                        mode: s.first_message_mode_telnyx || s.first_message_mode || 'speak-first',
                        prompt: s.system_prompt_telnyx || '',

                        voiceProvider: s.tts_provider_telnyx || s.tts_provider || 'azure',
                        voiceLang: s.voice_language_telnyx || 'es-MX',
                        voiceId: s.voice_name_telnyx || '',
                        voiceStyle: s.voice_style_telnyx || '',
                        voiceSpeed: s.voice_speed_telnyx || 1.0,
                        voicePacing: s.voice_pacing_ms_telnyx || 0,
                        voiceBgSound: s.background_sound_telnyx || 'none',
                        voiceBgUrl: s.background_sound_url_telnyx || '',

                        sttProvider: s.stt_provider_telnyx || 'azure',
                        sttLang: s.stt_language_telnyx || 'es-MX',
                        interruptWords: s.interruption_threshold_telnyx || 0,
                        interruptRMS: s.voice_sensitivity_telnyx || 0,
                        silence: s.silence_timeout_ms_telnyx || 5000,
                        inputMin: s.input_min_characters_telnyx || 0,
                        blacklist: s.hallucination_blacklist_telnyx || '',
                        denoise: s.enable_denoising_telnyx || false,
                        krisp: s.enable_krisp_telnyx || false,
                        vad: s.enable_vad_telnyx || false,

                        idleTimeout: s.idle_timeout_telnyx || 20,
                        maxDuration: s.max_duration_telnyx || 600,
                        idleMessage: s.idle_message_telnyx || '',
                        enableRecording: s.enable_recording_telnyx || false,
                        amdConfig: s.amd_config_telnyx || 'disabled'
                    };
                },

                refreshUI() {
                    this.updateModelList();
                    this.updateVoiceLists();
                    // Styles autom update via voice list
                },

                updateModelList() {
                    let prov = (this.c.provider || 'openai').toLowerCase();
                    this.availableModels = this.models[prov] || [];
                    // Ensure valid selection
                    if (this.c.model && !this.availableModels.find(m => m.id === this.c.model)) {
                        this.c.model = this.availableModels[0]?.id || '';
                    }
                },

                updateVoiceLists() {
                    let prov = (this.c.voiceProvider || 'azure').toLowerCase();
                    this.availableLanguages = this.languages[prov] || [];

                    // Validate Lang
                    if (!this.availableLanguages.find(l => l.id === this.c.voiceLang)) {
                        this.c.voiceLang = this.availableLanguages[0]?.id || '';
                    }

                    // Get Voices for Prov + Lang
                    let allVoices = (this.voices[prov] || {})[this.c.voiceLang] || [];

                    // Extract Genders
                    let gendersSet = new Set(allVoices.map(v => v.gender));
                    this.availableGenders = Array.from(gendersSet).map(g => ({
                        id: g,
                        name: g === 'female' ? 'Femenino' : (g === 'male' ? 'Masculino' : 'Neutral')
                    }));

                    // Ensure Gender Selection
                    if (!gendersSet.has(this.currentGender) && this.availableGenders.length > 0) {
                        this.currentGender = this.availableGenders[0].id; // Fallback
                    }

                    // Filter by Gender
                    this.availableVoices = allVoices.filter(v => v.gender === this.currentGender);

                    // Ensure Voice ID Selection
                    if (this.availableVoices.length > 0) {
                        let found = this.availableVoices.find(v => v.id === this.c.voiceId);
                        if (!found) {
                            this.c.voiceId = this.availableVoices[0].id;
                        }
                    }

                    this.updateStyleList();
                },

                updateStyleList() {
                    let vid = this.c.voiceId;
                    let rawStyles = this.styles[vid] || this.styles['default'] || [];

                    // Normalize strings to objects for UI template (which expects s.id and s.label)
                    this.availableStyles = rawStyles.map(s => {
                        if (typeof s === 'string') return { id: s, label: s.charAt(0).toUpperCase() + s.slice(1) };
                        return s;
                    });

                    // Validate Style
                    if (this.c.voiceStyle && !this.availableStyles.find(s => s.id === this.c.voiceStyle)) {
                        this.c.voiceStyle = ''; // Reset to default if current style not valid for this voice
                    }
                },

                setGender(g) {
                    this.currentGender = g;
                    this.updateVoiceLists();
                },

                shouldShowTab(t) {
                    if (t === 'Conexi√≥n' && this.activeProfile === 'browser') return false;
                    return true;
                },

                // SIMULATOR STATE
                simState: 'ready', // ready, connecting, connected
                ws: null,
                audioContext: null,
                mediaStream: null,
                processor: null,

                nextStartTime: 0,

                async startTest() {
                    if (this.simState === 'connected' || this.simState === 'connecting') {
                        this.stopTest();
                        return;
                    }

                    // 1. Initialize AudioContext at 16kHz (Standard Wideband)
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                        if (this.audioContext.state === 'suspended') {
                            await this.audioContext.resume();
                        }
                        console.log("AudioContext Initialized. SampleRate:", this.audioContext.sampleRate, "State:", this.audioContext.state);
                    } catch (e) {
                        console.error("Audio Context Init Failed", e);
                        alert("Audio Error: " + e.message);
                        return;
                    }

                    this.simState = 'connecting';
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/api/v1/ws/media-stream?client=browser`;

                    try {
                        this.ws = new WebSocket(wsUrl);

                        this.ws.onopen = () => {
                            console.log("WS Connected");
                            this.simState = 'connected';
                            this.initMicrophone(); // Logic split

                            // Send Start Event - PCM 16kHz
                            this.ws.send(JSON.stringify({
                                event: 'start',
                                start: {
                                    streamSid: 'browser-' + Date.now(),
                                    callSid: 'sim-' + Date.now(),
                                    media_format: { encoding: 'audio/pcm', sample_rate: 16000, channels: 1 }
                                }
                            }));
                        };

                        this.ws.onmessage = (event) => {
                            const msg = JSON.parse(event.data);

                            // 1. Handle Audio Media
                            if (msg.event === 'media' || msg.type === 'audio') {
                                const payload = msg.media ? msg.media.payload : msg.data;
                                this.playAudio(payload);
                            }

                            // 2. Handle Configuration (Background Sound)
                            else if (msg.type === 'config') {
                                console.log("‚öôÔ∏è [CONFIG] Received:", msg.config);
                                if (msg.config.background_sound && msg.config.background_sound !== 'none') {
                                    this.playBackgroundSound(msg.config.background_sound);
                                }
                            }
                        };

                        // ... (rest of WS handlers) ...
                        this.ws.onclose = () => { console.log("WS Closed"); this.stopTest(); };
                        this.ws.onerror = (e) => { console.error("WS Error", e); this.stopTest(); };

                    } catch (e) {
                        console.error("Connection failed", e);
                        this.stopTest();
                    }
                },

                async initMicrophone() {
                    try {
                        const constraints = {
                            audio: {
                                echoCancellation: this.c.denoise,
                                noiseSuppression: this.c.denoise,
                                autoGainControl: true
                            }
                        };
                        this.mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                        const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                        this.processor = this.audioContext.createScriptProcessor(4096, 1, 1);
                        source.connect(this.processor);
                        this.processor.connect(this.audioContext.destination);

                        this.processor.onaudioprocess = (e) => {
                            if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;

                            const inputData = e.inputBuffer.getChannelData(0); // Float32

                            // Convert Float32 (-1.0 to 1.0) -> Int16 PCM
                            // We need to send RAW BYTES (Int16, little-endian)
                            const pcm16 = new Int16Array(inputData.length);
                            for (let i = 0; i < inputData.length; i++) {
                                let s = Math.max(-1, Math.min(1, inputData[i]));
                                pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                            }

                            // Convert Int16Array -> Byte String -> Base64
                            const bytes = new Uint8Array(pcm16.buffer);
                            let binary = '';
                            const len = bytes.byteLength;
                            for (let i = 0; i < len; i++) {
                                binary += String.fromCharCode(bytes[i]);
                            }
                            const base64Audio = window.btoa(binary);

                            this.ws.send(JSON.stringify({
                                event: 'media',
                                media: { payload: base64Audio, track: 'inbound' }
                            }));
                        };
                    } catch (e) {
                        console.error("Mic Access Failed", e);
                        alert("Microphone Error: " + e.message);
                        this.stopTest();
                    }
                },

                stopTest() {
                    this.simState = 'ready';
                    if (this.ws) {
                        this.ws.close();
                        this.ws = null;
                    }
                    if (this.audioContext) {
                        this.audioContext.close();
                        this.audioContext = null;
                    }
                    if (this.mediaStream) {
                        this.mediaStream.getTracks().forEach(t => t.stop());
                        this.mediaStream = null;
                    }
                    if (this.bgAudio) {
                        this.bgAudio.pause();
                        this.bgAudio = null;
                    }
                },

                playAudio(base64Data) {
                    if (!base64Data) return;
                    // ... (existing playAudio logic) ...
                    try {
                        const binaryString = window.atob(base64Data);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }

                        const pcm16 = new Int16Array(bytes.buffer);
                        const float32 = new Float32Array(pcm16.length);

                        for (let i = 0; i < pcm16.length; i++) {
                            float32[i] = pcm16[i] / 32768.0;
                        }

                        if (!this.audioContext) return;

                        const buffer = this.audioContext.createBuffer(1, float32.length, 16000);
                        buffer.copyToChannel(float32, 0);

                        const source = this.audioContext.createBufferSource();
                        source.buffer = buffer;
                        source.connect(this.audioContext.destination);

                        const currentTime = this.audioContext.currentTime;
                        if (!this.nextStartTime || this.nextStartTime < currentTime) {
                            this.nextStartTime = currentTime;
                        }
                        source.start(this.nextStartTime);
                        this.nextStartTime += buffer.duration;
                    } catch (e) {
                        console.error("Playback Error", e);
                    }
                },

                bgAudio: null, // Store reference

                playBackgroundSound(soundName) {
                    // Stop existing
                    if (this.bgAudio) {
                        this.bgAudio.pause();
                        this.bgAudio = null;
                    }

                    // Map name to file path (Simple mapping)
                    // Assuming static files are at /static/sounds/
                    const volume = 0.1; // Low volume for background
                    const path = `/static/sounds/${soundName}.wav`;

                    console.log(`üéµ [BG-SOUND] Playing loop: ${path}`);

                    this.bgAudio = new Audio(path);
                    this.bgAudio.loop = true;
                    this.bgAudio.volume = volume;

                    // Attempt to play (user gesture usually required, but we are inside startTest so it might work)
                    this.bgAudio.play().catch(e => console.warn("Background Audio Play failed (Autoplay policy?):", e));
                },



                async saveConfig() {
                    const form = document.getElementById('configForm');
                    const urlParams = new URLSearchParams(window.location.search);
                    const apiKey = urlParams.get('api_key');

                    // Construct Payload
                    // Flattens the 'c' (current profile) back into the hidden inputs structure?
                    // actually, the hidden inputs are bound to :value="configs..."
                    // We need to send the ENTIRE state (all profiles) to match the Backend Schema expecting "temperature_phone", etc.

                    // Better approach for JSON: Send the flattened key-value pairs that the backend expects.
                    // We can construct this by reading the form data (which has the hidden inputs with correct names)
                    const formData = new FormData(form);
                    const payload = {};
                    formData.forEach((value, key) => payload[key] = value);

                    // Add dynamic API Key if missing
                    let endpoint = '/api/config/update-json';
                    if (apiKey) endpoint += `?api_key=${apiKey}`;

                    let btn = document.querySelector('button[type="submit"]');

                    try {
                        if (btn) btn.innerHTML = 'üíæ Guardando...';

                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            const data = await res.json();
                            console.log("‚úÖ Config Saved:", data);
                            this.showToast("Configuraci√≥n guardada correctamente", "success");
                        } else {
                            throw new Error(`Server Error: ${res.status}`);
                        }
                    } catch (e) {
                        console.error("Save Failed", e);
                        this.showToast("Error al guardar: " + e.message, "error");
                    } finally {
                        if (btn) btn.innerHTML = '<span class="mr-2">üíæ</span> Guardar Cambios';
                    }
                },

                // Toast Logic
                showToast(msg, type = 'success') {
                    // Create element dynamically
                    const div = document.createElement('div');
                    div.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl text-sm font-medium transform transition-all duration-300 translate-y-10 opacity-0 z-50 ${type === 'success' ? 'bg-emerald-600/90 text-white' : 'bg-red-600/90 text-white'}`;
                    div.textContent = msg;
                    document.body.appendChild(div);

                    // Animate In
                    requestAnimationFrame(() => {
                        div.classList.remove('translate-y-10', 'opacity-0');
                    });

                    // Remove
                    setTimeout(() => {
                        div.classList.add('translate-y-10', 'opacity-0');
                        setTimeout(() => div.remove(), 300);
                    }, 3000);
                }
            }
        }
    </script>
</body>

</html>