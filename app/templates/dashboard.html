<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Asistente IA</title>
    <!-- AlpineJS removed here - loaded via main.js module -->
    <link href="{{ url_for('static', path='css/output.css') }}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #0f172a;
            color: #ffffff;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .glass-input:focus {
            border-color: #3b82f6;
            background: rgba(15, 23, 42, 0.95);
            outline: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .animate-pulse-ring::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 2px solid #34d399;
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>

<body class="overflow-hidden h-screen flex flex-col" x-data="dashboard()">

    <!-- Data Injection -->
    <script id="server-config" type="application/json">
        {{ config_json | safe }}
    </script>
    <script id="server-voices" type="application/json">
        {{ voices_json | safe }}
    </script>
    <script id="server-styles" type="application/json">
        {{ styles_json | safe }}
    </script>
    <script id="server-models" type="application/json">
        {{ models_json | safe }}
    </script>
    <script id="server-langs" type="application/json">
        {{ langs_json | safe }}
    </script>

    <!-- HEADER -->
    <header
        class="h-16 border-b border-slate-700 bg-slate-900/50 backdrop-blur flex items-center justify-between px-6 shrink-0 relative z-20">
        <div class="flex items-center space-x-3">
            <div
                class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center shadow-lg shadow-blue-500/20">
                <span class="text-xs font-bold">IA</span>
            </div>
            <h1
                class="font-bold text-lg tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-200">
                Panel de Control
            </h1>
        </div>

        <!-- Perfil Selector -->
        <div class="flex items-center bg-slate-800 rounded-lg p-1 border border-slate-700">
            <template x-for="p in ['browser', 'twilio', 'telnyx']">
                <button @click="activeProfile = p"
                    :class="{'bg-slate-700 text-white shadow': activeProfile === p, 'text-slate-400 hover:text-slate-200': activeProfile !== p}"
                    class="px-4 py-1.5 rounded-md text-xs font-medium transition-all capitalize flex items-center space-x-2">
                    <span x-text="p === 'browser' ? 'ðŸŒ' : (p === 'twilio' ? 'ðŸ“±' : 'ðŸ“¡')"></span>
                    <span x-text="p"></span>
                </button>
            </template>
        </div>
    </header>

    <!-- MAIN CONTENT WRAPPER -->
    <div class="flex h-[calc(100vh-64px)] overflow-hidden">

        <!-- LEFT SIDEBAR: CONFIGURATION (Fixed Width for Usability) -->
        <aside
            class="w-full lg:w-[480px] xl:w-[520px] flex flex-col border-r border-slate-800 bg-slate-900/50 backdrop-blur-sm shrink-0 transition-all duration-300">

            <div class="p-4 h-full flex flex-col relative">
                <form id="configForm" @submit.prevent="saveConfig()" class="h-full flex flex-col">

                    <!-- TABS CONTAINER -->
                    <div
                        class="p-1 bg-slate-800/50 rounded-lg flex space-x-1 mb-4 shrink-0 overflow-x-auto no-scrollbar border border-slate-700/50 sticky top-0 z-10">
                        <template
                            x-for="tab in [{id:'model',icon:'ðŸ§ ',label:'Modelo'}, {id:'voz',icon:'ðŸ—£ï¸',label:'Voz'}, {id:'transcriptor',icon:'ðŸ‘‚',label:'OÃ­do'}, {id:'campaigns',icon:'ðŸ“£',label:'CampaÃ±as'}, {id:'avanzado',icon:'âš™ï¸',label:'A'}, {id:'historial',icon:'ðŸ“œ',label:'H'}, {id:'conexion',icon:'ðŸ”Œ',label:'C'}]">
                            <button type="button" @click="activeTab = tab.id" x-show="shouldShowTab(tab.label)"
                                :class="{'bg-blue-600 text-white shadow-md': activeTab === tab.id, 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50': activeTab !== tab.id}"
                                class="flex-1 px-3 py-2 rounded-md text-xs font-medium transition-all flex items-center justify-center space-x-1 whitespace-nowrap"
                                :title="tab.label.length > 2 ? '' : (tab.id === 'avanzado' ? 'Avanzado' : (tab.id === 'historial' ? 'Historial' : 'ConexiÃ³n'))">
                                <span x-text="tab.icon"></span>
                                <span x-text="tab.label.length > 2 ? tab.label : ''" class="hidden sm:inline"></span>
                            </button>
                        </template>
                    </div>

                    <!-- SCROLLABLE CONFIG AREA -->
                    <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-4" id="config-scroll-area">
                        {% include 'partials/tab_model.html' %}
                        {% include 'partials/tab_voice.html' %}
                        {% include 'partials/tab_transcriber.html' %}
                        {% include 'partials/tab_campaigns.html' %}
                        {% include 'partials/tab_advanced.html' %}
                        {% include 'partials/tab_history.html' %}
                        {% include 'partials/tab_connectivity.html' %}

                        <!-- HIDDEN INPUTS PRESERVED HERE -->
                        <!-- Browser Profile (Default) -->
                        <input type="hidden" name="llm_provider" :value="configs.browser.provider">
                        <input type="hidden" name="llm_model" :value="configs.browser.model">
                        <input type="hidden" name="temperature" :value="configs.browser.temp">
                        <input type="hidden" name="max_tokens" :value="configs.browser.tokens">
                        <input type="hidden" name="first_message" :value="configs.browser.msg">
                        <input type="hidden" name="first_message_mode" :value="configs.browser.mode">
                        <input type="hidden" name="system_prompt" :value="configs.browser.prompt">

                        <input type="hidden" name="tts_provider" :value="configs.browser.voiceProvider">
                        <input type="hidden" name="voice_name" :value="configs.browser.voiceId">
                        <input type="hidden" name="voice_style" :value="configs.browser.voiceStyle">
                        <input type="hidden" name="voice_speed" :value="configs.browser.voiceSpeed">
                        <input type="hidden" name="voice_pitch" :value="configs.browser.voicePitch">
                        <input type="hidden" name="voice_volume" :value="configs.browser.voiceVolume">
                        <input type="hidden" name="voice_style_degree" :value="configs.browser.voiceStyleDegree">
                        <input type="hidden" name="voice_pacing_ms" :value="configs.browser.voicePacing">
                        <input type="hidden" name="background_sound" :value="configs.browser.voiceBgSound">
                        <input type="hidden" name="background_sound_url" :value="configs.browser.voiceBgUrl">

                        <input type="hidden" name="stt_provider" :value="configs.browser.sttProvider">
                        <input type="hidden" name="stt_language" :value="configs.browser.sttLang">
                        <input type="hidden" name="interruption_threshold" :value="configs.browser.interruptWords">
                        <input type="hidden" name="silence_timeout_ms" :value="configs.browser.silence">
                        <input type="hidden" name="hallucination_blacklist" :value="configs.browser.blacklist">

                        <input type="hidden" name="enable_end_call" :value="configs.browser.enableEndCall">
                        <input type="hidden" name="enable_dial_keypad" :value="configs.browser.dialKeypad">
                        <input type="hidden" name="transfer_phone_number" :value="configs.browser.transferNum">

                        <input type="hidden" name="idle_timeout" :value="configs.browser.idleTimeout">
                        <input type="hidden" name="max_duration" :value="configs.browser.maxDuration">
                        <input type="hidden" name="idle_message" :value="configs.browser.idleMessage">
                        <input type="hidden" name="inactivity_max_retries" :value="configs.browser.maxRetries">
                        <input type="hidden" name="enable_denoising" :value="configs.browser.denoise">
                        <input type="hidden" name="extraction_model" :value="configs.browser.extractionModel">

                        <input type="hidden" name="response_length" :value="configs.browser.responseLength">
                        <input type="hidden" name="conversation_tone" :value="configs.browser.conversationTone">
                        <input type="hidden" name="conversation_formality"
                            :value="configs.browser.conversationFormality">
                        <input type="hidden" name="conversation_pacing" :value="configs.browser.conversationPacing">

                        <input type="hidden" name="llm_provider_phone" :value="configs.twilio.provider">
                        <input type="hidden" name="llm_model_phone" :value="configs.twilio.model">
                        <input type="hidden" name="temperature_phone" :value="configs.twilio.temp">
                        <input type="hidden" name="max_tokens_phone" :value="configs.twilio.tokens">
                        <input type="hidden" name="system_prompt_phone" :value="configs.twilio.prompt">
                        <input type="hidden" name="first_message_phone" :value="configs.twilio.msg">
                        <input type="hidden" name="first_message_mode_phone" :value="configs.twilio.mode">

                        <input type="hidden" name="tts_provider_phone" :value="configs.twilio.voiceProvider">
                        <input type="hidden" name="voice_name_phone" :value="configs.twilio.voiceId">
                        <input type="hidden" name="voice_style_phone" :value="configs.twilio.voiceStyle">
                        <input type="hidden" name="voice_speed_phone" :value="configs.twilio.voiceSpeed">
                        <input type="hidden" name="voice_pitch_phone" :value="configs.twilio.voicePitch">
                        <input type="hidden" name="voice_volume_phone" :value="configs.twilio.voiceVolume">
                        <input type="hidden" name="voice_style_degree_phone" :value="configs.twilio.voiceStyleDegree">
                        <input type="hidden" name="voice_pacing_ms_phone" :value="configs.twilio.voicePacing">
                        <input type="hidden" name="background_sound_phone" :value="configs.twilio.voiceBgSound">

                        <input type="hidden" name="stt_provider_phone" :value="configs.twilio.sttProvider">
                        <input type="hidden" name="stt_language_phone" :value="configs.twilio.sttLang">
                        <input type="hidden" name="interruption_threshold_phone" :value="configs.twilio.interruptWords">
                        <input type="hidden" name="silence_timeout_ms_phone" :value="configs.twilio.silence">
                        <input type="hidden" name="input_min_characters_phone" :value="configs.twilio.inputMin">
                        <input type="hidden" name="hallucination_blacklist_phone" :value="configs.twilio.blacklist">
                        <input type="hidden" name="enable_denoising_phone" :value="configs.twilio.denoise">

                        <input type="hidden" name="response_length_phone" :value="configs.twilio.responseLength">
                        <input type="hidden" name="conversation_tone_phone" :value="configs.twilio.conversationTone">
                        <input type="hidden" name="conversation_formality_phone"
                            :value="configs.twilio.conversationFormality">
                        <input type="hidden" name="conversation_pacing_phone"
                            :value="configs.twilio.conversationPacing">

                        <input type="hidden" name="llm_provider_telnyx" :value="configs.telnyx.provider">
                        <input type="hidden" name="llm_model_telnyx" :value="configs.telnyx.model">
                        <input type="hidden" name="temperature_telnyx" :value="configs.telnyx.temp">
                        <input type="hidden" name="max_tokens_telnyx" :value="configs.telnyx.tokens">
                        <input type="hidden" name="system_prompt_telnyx" :value="configs.telnyx.prompt">
                        <input type="hidden" name="first_message_telnyx" :value="configs.telnyx.msg">
                        <input type="hidden" name="first_message_mode_telnyx" :value="configs.telnyx.mode">

                        <input type="hidden" name="tts_provider_telnyx" :value="configs.telnyx.voiceProvider">
                        <input type="hidden" name="voice_name_telnyx" :value="configs.telnyx.voiceId">
                        <input type="hidden" name="voice_style_telnyx" :value="configs.telnyx.voiceStyle">
                        <input type="hidden" name="voice_speed_telnyx" :value="configs.telnyx.voiceSpeed">
                        <input type="hidden" name="voice_pitch_telnyx" :value="configs.telnyx.voicePitch">
                        <input type="hidden" name="voice_volume_telnyx" :value="configs.telnyx.voiceVolume">
                        <input type="hidden" name="voice_style_degree_telnyx" :value="configs.telnyx.voiceStyleDegree">
                        <input type="hidden" name="voice_pacing_ms_telnyx" :value="configs.telnyx.voicePacing">
                        <input type="hidden" name="background_sound_telnyx" :value="configs.telnyx.voiceBgSound">
                        <input type="hidden" name="background_sound_url_telnyx" :value="configs.telnyx.voiceBgUrl">

                        <input type="hidden" name="stt_provider_telnyx" :value="configs.telnyx.sttProvider">
                        <input type="hidden" name="stt_language_telnyx" :value="configs.telnyx.sttLang">
                        <input type="hidden" name="interruption_threshold_telnyx"
                            :value="configs.telnyx.interruptWords">
                        <input type="hidden" name="voice_sensitivity_telnyx" :value="configs.telnyx.interruptRMS">
                        <input type="hidden" name="silence_timeout_ms_telnyx" :value="configs.telnyx.silence">
                        <input type="hidden" name="input_min_characters_telnyx" :value="configs.telnyx.inputMin">
                        <input type="hidden" name="hallucination_blacklist_telnyx" :value="configs.telnyx.blacklist">
                        <input type="hidden" name="enable_denoising_telnyx" :value="configs.telnyx.denoise">
                        <input type="hidden" name="enable_krisp_telnyx" :value="configs.telnyx.krisp">
                        <input type="hidden" name="enable_vad_telnyx" :value="configs.telnyx.vad">

                        <input type="hidden" name="idle_timeout_telnyx" :value="configs.telnyx.idleTimeout">
                        <input type="hidden" name="max_duration_telnyx" :value="configs.telnyx.maxDuration">
                        <input type="hidden" name="idle_message_telnyx" :value="configs.telnyx.idleMessage">
                        <input type="hidden" name="enable_recording_telnyx" :value="configs.telnyx.enableRecording">
                        <input type="hidden" name="amd_config_telnyx" :value="configs.telnyx.amdConfig">

                        <input type="hidden" name="response_length_telnyx" :value="configs.telnyx.responseLength">
                        <input type="hidden" name="conversation_tone_telnyx" :value="configs.telnyx.conversationTone">
                        <input type="hidden" name="conversation_formality_telnyx"
                            :value="configs.telnyx.conversationFormality">
                        <input type="hidden" name="conversation_pacing_telnyx"
                            :value="configs.telnyx.conversationPacing">

                        <input type="hidden" name="crm_enabled" :value="configs.browser.crm_enabled">
                        <input type="hidden" name="baserow_token" :value="configs.browser.baserow_token">
                        <input type="hidden" name="baserow_table_id" :value="configs.browser.baserow_table_id">
                        <input type="hidden" name="webhook_url" :value="configs.browser.webhook_url">
                        <input type="hidden" name="webhook_secret" :value="configs.browser.webhook_secret">
                    </div>

                    <!-- FOOTER ACTIONS -->
                    <div x-show="activeTab !== 'historial'"
                        class="pt-4 mt-auto border-t border-slate-700/50 flex justify-end">
                        <button type="submit"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg text-sm font-semibold shadow-lg shadow-blue-500/20 transition-all flex items-center space-x-2 w-full justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            <span>Guardar Cambios</span>
                        </button>
                    </div>
                </form>
            </div>
        </aside>

        <!-- MAIN AREA: SIMULATOR & PREVIEWS -->
        <main class="flex-1 bg-gradient-to-br from-slate-900 to-slate-950 p-6 overflow-hidden relative">
            <div class="max-w-5xl mx-auto h-full flex flex-col justify-center">
                {% include 'partials/panel_simulator.html' %}

                <!-- Empty State Decoration if needed -->
                <div class="absolute inset-0 pointer-events-none flex items-center justify-center opacity-[0.02]">
                    <span class="text-[200px] font-bold">IA</span>
                </div>
            </div>
        </main>

    </div>

    <!-- JAVASCRIPT MODULES -->
    <script type="module" src="{{ url_for('static', path='js/main.js') }}"></script>
</body>

</html>