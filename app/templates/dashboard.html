<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orquestador de Voz Nativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="//unpkg.com/alpinejs" defer></script>
    <style>
        /* FANCY UI VARIABLES */
        :root {
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: #0f172a;
            /* Slate 900 */
            background-image:
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }
    </style>
</head>

<body class="text-slate-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-[1800px]"> <!-- Wider container for 60/40 -->

        <!-- HEADER -->
        <header class="mb-8 flex justify-between items-center glass-panel rounded-2xl px-6 py-4 shadow-2xl">
            <div class="flex items-center gap-4">
                <div
                    class="h-10 w-10 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <span class="text-2xl">üéôÔ∏è</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white">Orquestador de Voz Nativo</h1>
                    <p class="text-xs text-slate-400 font-mono tracking-wide uppercase">Panel de Control Unificado</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div
                    class="px-4 py-1.5 bg-emerald-500/10 border border-emerald-500/20 rounded-full flex items-center gap-2">
                    <span class="relative flex h-2 w-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    <span class="text-xs font-bold text-emerald-400 shadow-sm">En L√≠nea</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 relative items-start">

            <!-- LEFT PANEL: CONFIGURATION (60% -> 3/5 cols) -->
            <div class="lg:col-span-3 space-y-6">

                <h2 class="text-lg font-semibold text-white/90 px-2 border-l-4 border-blue-500">Configuraci√≥n del Agente
                </h2>

                <div class="glass-panel p-6 rounded-2xl shadow-xl space-y-6">


                    <div x-data="{ 
                    tab: 'model', 
                    activeProfile: 'browser',
                    
                    // --- DATA STORES (From Backend) ---
                    configs: {
                        browser: {
                            provider: '{{ config.llm_provider }}',
                            model: '{{ config.llm_model }}',
                            temp: {{ config.temperature or 0.7 }},
                            tokens: {{ config.max_tokens or 250 }},
                            msg: '{{ config.first_message }}',
                            mode: '{{ config.first_message_mode }}',
                            prompt: `{{ config.system_prompt | replace('`', '\`') | safe }}`
                            // --- VOICE CONFIG ---
                            voiceProvider: '{{ config.tts_provider }}',
                            voiceLang: '{{ config.voice_language or " es-MX" }}', voiceId: '{{ config.voice_name }}' ,
                        voiceStyle: '{{ config.voice_style }}' , voiceSpeed: {{ config.voice_speed or 1.0 }},
                        voicePacing: {{ config.voice_pacing_ms or 0 }}, // Naturality delay
                        voiceBgSound: '{{ config.background_sound }}' , voiceBgUrl: '{{ config.background_sound_url }}'
                        }, twilio: { provider: '{{ config.llm_provider_phone }}' || '{{ config.llm_provider }}' ,
                        model: '{{ config.llm_model_phone }}' || '{{ config.llm_model }}' , temp: {{
                        config.temperature_phone or config.temperature or 0.7 }}, tokens: {{ config.max_tokens_phone or
                        config.max_tokens or 250 }}, msg: '{{ config.first_message_phone }}'
                        || '{{ config.first_message }}' , mode: '{{ config.first_message_mode_phone }}'
                        || '{{ config.first_message_mode }}' , prompt: `{{ config.system_prompt_phone |
                        replace('`', '\`' ) | safe }}` || `{{ config.system_prompt | replace('`', '\`' ) | safe }}`, //
                        --- VOICE CONFIG PHONE --- voiceProvider: '{{ config.tts_provider_phone }}'
                        || '{{ config.tts_provider }}' , voiceLang: '{{ config.voice_language_phone or "es-MX" }}' ,
                        voiceId: '{{ config.voice_name_phone }}' , voiceStyle: '{{ config.voice_style_phone }}' ,
                        voiceSpeed: {{ config.voice_speed_phone or 1.0 }}, voicePacing: {{ config.voice_pacing_ms_phone
                        or 0 }}, voiceBgSound: '{{ config.background_sound_phone }}' ,
                        voiceBgUrl: '{{ config.background_sound_url_phone }}' }, telnyx: {
                        provider: '{{ config.llm_provider_telnyx }}' || '{{ config.llm_provider }}' ,
                        model: '{{ config.llm_model_telnyx }}' || '{{ config.llm_model }}' , temp: {{
                        config.temperature_telnyx or config.temperature or 0.7 }}, tokens: {{ config.max_tokens_telnyx
                        or config.max_tokens or 250 }}, msg: '{{ config.first_message_telnyx }}'
                        || '{{ config.first_message }}' , mode: '{{ config.first_message_mode_telnyx }}'
                        || '{{ config.first_message_mode }}' , prompt: `{{ config.system_prompt_telnyx |
                        replace('`', '\`' ) | safe }}` || `{{ config.system_prompt | replace('`', '\`' ) | safe }}`, //
                        --- VOICE CONFIG TELNYX --- voiceProvider: '{{ config.tts_provider_telnyx }}'
                        || '{{ config.tts_provider }}' , voiceLang: '{{ config.voice_language_telnyx or "es-MX" }}' ,
                        voiceId: '{{ config.voice_name_telnyx }}' , voiceStyle: '{{ config.voice_style_telnyx }}' ,
                        voiceSpeed: {{ config.voice_speed_telnyx or 1.0 }}, voicePacing: {{
                        config.voice_pacing_ms_telnyx or 0 }}, voiceBgSound: '{{ config.background_sound_telnyx }}' ,
                        voiceBgUrl: '{{ config.background_sound_url_telnyx }}' } }, // --- UI BOUND VARIABLES ---
                        currentProvider: '' , currentModel: '' , currentTemp: 0.7, maxTokens: 250, firstMessage: '' ,
                        firstMessageMode: 'speak-first' , systemPrompt: '' , availableModels: [], // --- UI BOUND VOICE
                        VARIABLES --- currentVoiceProvider: 'azure' , currentVoiceLang: 'es-MX' , currentVoiceId: '' ,
                        currentVoiceStyle: '' , currentVoiceSpeed: 1.0, currentVoicePacing: 0, currentBgSound: 'none' ,
                        currentBgUrl: '' , // --- DYNAMIC LISTS --- availableLanguages: [], availableVoices: [],
                        availableStyles: [], // --- CONSTANTS --- models: { groq: [ {id:'llama-3.3-70b-versatile',
                        name:'‚ö° Llama 3.3 70B (Versatile)'}, {id:'llama-3.1-8b-instant', name:'‚ö° Llama 3.1 8B
                        (Instant)'}, {id:'mixtral-8x7b-32768', name:'‚ö° Mixtral 8x7B'} ], openai: [ {id:'gpt-4o',
                        name:'üß† GPT-4o (Omni)'}, {id:'gpt-4-turbo', name:'ü§ñ GPT-4 Turbo'}, {id:'gpt-3.5-turbo',
                        name:'‚ö° GPT-3.5 Turbo'} ], azure: [ {id:'gpt-4o', name:'‚òÅÔ∏è Azure GPT-4o'}, {id:'gpt-35-turbo',
                        name:'‚òÅÔ∏è Azure GPT-3.5'} ] }, // --- VOICE CONSTANTS --- voiceProviders: [ {id: 'azure' ,
                        name: 'Azure Speech' , icon: '‚òÅÔ∏è' }, {id: 'elevenlabs' , name: 'ElevenLabs' , icon: 'üì¢' },
                        {id: 'openai' , name: 'OpenAI Audio' , icon: 'ü§ñ' } ], voiceLanguages: { 'azure' : [
                        {id: 'es-MX' , name: 'üá≤üáΩ Espa√±ol (M√©xico)' }, {id: 'es-ES' , name: 'üá™üá∏ Espa√±ol (Espa√±a)' },
                        {id: 'en-US' , name: 'üá∫üá∏ Ingl√©s (USA)' } ], 'elevenlabs' : [ {id: 'es' ,
                        name: 'üá≤üáΩ/üá™üá∏ Espa√±ol (Global)' }, {id: 'en' , name: 'üá∫üá∏ Ingl√©s (Global)' } ], 'openai' : [
                        {id: 'global' , name: 'Global (Auto)' } ] }, voiceCatalog: { 'azure' : { 'es-MX' : [
                        {id: 'es-MX-DaliaNeural' , name: 'Dalia (Femenina)' , gender: 'female' },
                        {id: 'es-MX-JorgeNeural' , name: 'Jorge (Masculina)' , gender: 'male' },
                        {id: 'es-MX-CecilioNeural' , name: 'Cecilio (Masculina)' , gender: 'male' },
                        {id: 'es-MX-MarinaNeural' , name: 'Marina (Femenina)' , gender: 'female' } ], 'es-ES' : [
                        {id: 'es-ES-ElviraNeural' , name: 'Elvira (Femenina)' , gender: 'female' },
                        {id: 'es-ES-AlvaroNeural' , name: 'Alvaro (Masculina)' , gender: 'male' } ], 'en-US' : [
                        {id: 'en-US-JennyNeural' , name: 'Jenny (Female)' , gender: 'female' }, {id: 'en-US-GuyNeural' ,
                        name: 'Guy (Male)' , gender: 'male' } ] }, 'elevenlabs' : { 'es' : [ {id: 'rachel' ,
                        name: 'Rachel (Femenina)' , gender: 'female' }, {id: 'josh' , name: 'Josh (Masculina)' ,
                        gender: 'male' } ], 'en' : [ {id: 'rachel' , name: 'Rachel (Female)' , gender: 'female' },
                        {id: 'josh' , name: 'Josh (Male)' , gender: 'male' } ] }, 'openai' : { 'global' : [ {id: 'alloy'
                        , name: 'Alloy' , gender: 'neutral' }, {id: 'echo' , name: 'Echo' , gender: 'neutral' },
                        {id: 'fable' , name: 'Fable' , gender: 'neutral' }, {id: 'onyx' , name: 'Onyx' ,
                        gender: 'neutral' }, {id: 'nova' , name: 'Nova' , gender: 'neutral' }, {id: 'shimmer' ,
                        name: 'Shimmer' , gender: 'neutral' } ] } }, // We reuse the existing voiceStyles object for the
                        styles mapping backgroundSounds: [ {id: 'none' , name: 'üîá Silencio' }, {id: 'office' ,
                        name: 'üè¢ Oficina' }, {id: 'cafe' , name: '‚òï Cafeter√≠a' }, {id: 'callcenter' ,
                        name: 'üìû Call Center' }, {id: 'custom' , name: 'üîó URL Personalizada' } ], init() {
                        this.loadProfile(this.activeProfile); // Watch for profile changes this.$watch('activeProfile',
                        val=> this.loadProfile(val));

                        // Sync UI changes back to internal store (MODEL)
                        this.$watch('currentProvider', v => { this.configs[this.activeProfile].provider = v;
                        this.updateModelList(); });
                        this.$watch('currentModel', v => this.configs[this.activeProfile].model = v);
                        this.$watch('currentTemp', v => this.configs[this.activeProfile].temp = v);
                        this.$watch('maxTokens', v => this.configs[this.activeProfile].tokens = v);
                        this.$watch('firstMessage', v => this.configs[this.activeProfile].msg = v);
                        this.$watch('firstMessageMode', v => this.configs[this.activeProfile].mode = v);
                        this.$watch('systemPrompt', v => this.configs[this.activeProfile].prompt = v);

                        // Sync UI changes back to internal store (VOICE)
                        this.$watch('currentVoiceProvider', v => {
                        this.configs[this.activeProfile].voiceProvider = v;
                        this.updateVoiceLists();
                        });
                        this.$watch('currentVoiceLang', v => {
                        this.configs[this.activeProfile].voiceLang = v;
                        this.updateVoiceLists();
                        });
                        this.$watch('currentVoiceId', v => {
                        this.configs[this.activeProfile].voiceId = v;
                        this.updateStyleList();
                        });
                        this.$watch('currentVoiceStyle', v => this.configs[this.activeProfile].voiceStyle = v);
                        this.$watch('currentVoiceSpeed', v => this.configs[this.activeProfile].voiceSpeed = v);
                        this.$watch('currentVoicePacing', v => this.configs[this.activeProfile].voicePacing = v);
                        this.$watch('currentBgSound', v => this.configs[this.activeProfile].voiceBgSound = v);
                        this.$watch('currentBgUrl', v => this.configs[this.activeProfile].voiceBgUrl = v);
                        },

                        loadProfile(p) {
                        let c = this.configs[p];
                        if(!c) return;
                        // MODEL
                        this.currentProvider = c.provider;
                        this.updateModelList();
                        this.currentModel = c.model;
                        this.currentTemp = c.temp;
                        this.maxTokens = c.tokens;
                        this.firstMessage = c.msg;
                        this.firstMessageMode = c.mode;
                        this.systemPrompt = c.prompt;

                        // VOICE
                        this.currentVoiceProvider = c.voiceProvider || 'azure';
                        this.currentVoiceLang = c.voiceLang || 'es-MX';
                        this.updateVoiceLists(); // Calculates available based on prov/lang

                        // Set ID after lists population to ensure validity
                        this.currentVoiceId = c.voiceId;
                        this.updateStyleList();

                        this.currentVoiceStyle = c.voiceStyle;
                        this.currentVoiceSpeed = c.voiceSpeed;
                        this.currentVoicePacing = c.voicePacing;
                        this.currentBgSound = c.voiceBgSound;
                        this.currentBgUrl = c.voiceBgUrl;
                        },

                        updateModelList() {
                        this.availableModels = this.models[this.currentProvider] || [];
                        // Validate current model exists in new list
                        if (this.currentModel && !this.availableModels.find(m => m.id === this.currentModel)) {
                        this.currentModel = this.availableModels[0]?.id || '';
                        }
                        },

                        updateVoiceLists() {
                        // 1. Get Languages for Provider
                        this.availableLanguages = this.voiceLanguages[this.currentVoiceProvider] || [];
                        // Ensure valid lang
                        if (!this.availableLanguages.find(l => l.id === this.currentVoiceLang)) {
                        this.currentVoiceLang = this.availableLanguages[0]?.id || '';
                        }

                        // 2. Get Voices for Lang
                        const providerVoices = this.voiceCatalog[this.currentVoiceProvider] || {};
                        this.availableVoices = providerVoices[this.currentVoiceLang] || [];

                        // Ensure valid voice if not empty
                        if (this.availableVoices.length > 0 && !this.availableVoices.find(v => v.id ===
                        this.currentVoiceId)) {
                        // Use config voice if valid, otherwise first available
                        // We don't overwrite if it might be a valid manual ID?
                        // For now, let's select first if invalid to support dropdown Logic
                        this.currentVoiceId = this.availableVoices[0].id;
                        }

                        this.updateStyleList();
                        },

                        updateStyleList() {
                        this.availableStyles = this.voiceStyles[this.currentVoiceId] || [];
                        // Ensure valid style
                        if (this.availableStyles.length > 0) {
                        if (!this.availableStyles.find(s => s.id === this.currentVoiceStyle)) {
                        this.currentVoiceStyle = this.availableStyles[0].id;
                        }
                        } else {
                        this.currentVoiceStyle = '';
                        }
                        },

                        /* Legacy Variables needed for other tabs */
                        interruptionPhone: {{ config.interruption_threshold_phone or 2 }},
                        voiceSpeedPhone: {{ config.voice_speed_phone or 0.9 }},
                        silencePhone: {{ config.silence_timeout_ms_phone or 1200 }},

                        /* Telnyx State */
                        interruptionTelnyx: {{ config.interruption_threshold_telnyx or 2 }},
                        voiceSpeedTelnyx: {{ config.voice_speed_telnyx or 0.9 }},
                        voicePacingTelnyx: {{ config.voice_pacing_ms_telnyx or 500 }},
                        activeVoice: '{{ config.voice_name_telnyx or " es-MX-DaliaNeural" }}', voiceStyles:
                        { 'es-MX-DaliaNeural' : [ {id: 'cheerful' , label: 'Alegre (Cheerful)' }, {id: 'sad' ,
                        label: 'Triste (Sad)' }, {id: 'whispering' , label: 'Susurrando (Whispering)' }, {id: 'friendly'
                        , label: 'Amigable (Friendly)' }, {id: 'excited' , label: 'Entusiasmado (Excited)' },
                        {id: 'hopeful' , label: 'Esperanzado (Hopeful)' }, {id: 'terrified' ,
                        label: 'Aterrorizado (Terrified)' }, {id: 'angry' , label: 'Enojado (Angry)' }, {id: 'chat' ,
                        label: 'Charla (Chat)' }, {id: 'customerservice' , label: 'Servicio al Cliente' }
                        ], 'es-MX-JorgeNeural' : [ {id: 'cheerful' , label: 'Alegre (Cheerful)' }, {id: 'chat' ,
                        label: 'Charla (Chat)' }, {id: 'sad' , label: 'Triste (Sad)' }, {id: 'whispering' ,
                        label: 'Susurrando (Whispering)' } ], 'es-MX-CecilioNeural' : [ {id: 'cheerful' ,
                        label: 'Alegre (Cheerful)' }, {id: 'sad' , label: 'Triste (Sad)' }, {id: 'angry' ,
                        label: 'Enojado (Angry)' }, {id: 'hopeful' , label: 'Esperanzado (Hopeful)' }, {id: 'friendly' ,
                        label: 'Amigable (Friendly)' }, {id: 'unfriendly' , label: 'Antip√°tico (Unfriendly)' },
                        {id: 'terrified' , label: 'Aterrorizado (Terrified)' }, {id: 'excited' ,
                        label: 'Entusiasmado (Excited)' }, {id: 'whispering' , label: 'Susurrando (Whispering)' },
                        {id: 'shouting' , label: 'Gritando (Shouting)' } ], 'es-MX-MarinaNeural' : [ {id: 'cheerful' ,
                        label: 'Alegre (Cheerful)' }, {id: 'sad' , label: 'Triste (Sad)' }, {id: 'whispering' ,
                        label: 'Susurrando (Whispering)' }, {id: 'friendly' , label: 'Amigable (Friendly)' },
                        {id: 'excited' , label: 'Entusiasmado (Excited)' }, {id: 'hopeful' ,
                        label: 'Esperanzado (Hopeful)' }, {id: 'terrified' , label: 'Aterrorizado (Terrified)' },
                        {id: 'angry' , label: 'Enojado (Angry)' }, {id: 'chat' , label: 'Charla (Chat)' },
                        {id: 'customerservice' , label: 'Servicio al Cliente' } ], 'en-US-JennyNeural' : [
                        {id: 'assistant' , label: 'Asistente' }, {id: 'chat' , label: 'Charla' }, {id: 'customerservice'
                        , label: 'Servicio Cliente' }, {id: 'newscast' , label: 'Noticias' }, {id: 'angry' ,
                        label: 'Enojado' }, {id: 'cheerful' , label: 'Alegre' }, {id: 'sad' , label: 'Triste' },
                        {id: 'excited' , label: 'Entusiasmado' }, {id: 'friendly' , label: 'Amigable' },
                        {id: 'terrified' , label: 'Aterrorizado' }, {id: 'shouting' , label: 'Gritando' },
                        {id: 'unfriendly' , label: 'Antip√°tico' }, {id: 'whispering' , label: 'Susurrando' },
                        {id: 'hopeful' , label: 'Esperanzado' } ], 'default' : [] }, get currentStyles() { return
                        this.voiceStyles[this.activeVoice] || this.voiceStyles['default']; }, historyFilter: 'all' }">
                        <!-- GLOBAL PROFILE TOGGLE -->
                        <div
                            class="flex space-x-2 bg-slate-900/50 rounded-lg p-1 mb-8 border border-slate-700/50 shadow-lg">
                            <button type="button"
                                @click="activeProfile = 'browser'; document.getElementById('sim-mode-text').innerText = 'Navegador'; document.getElementById('sim-mode-text').className = 'text-blue-400'; window.simulatorClientType = 'browser';"
                                :class="{'bg-blue-600 text-white shadow-lg scale-[1.02]': activeProfile === 'browser', 'text-slate-400 hover:text-white': activeProfile !== 'browser'}"
                                class="flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all focus:outline-none flex items-center justify-center gap-2">
                                <span class="text-lg">üåê</span> Simulador
                            </button>
                            <button type="button"
                                @click="activeProfile = 'twilio'; document.getElementById('sim-mode-text').innerText = 'Twilio'; document.getElementById('sim-mode-text').className = 'text-red-400'; window.simulatorClientType = 'twilio';"
                                :class="{'bg-red-600 text-white shadow-lg scale-[1.02]': activeProfile === 'twilio', 'text-slate-400 hover:text-white': activeProfile !== 'twilio'}"
                                class="flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all focus:outline-none flex items-center justify-center gap-2">
                                <span class="text-lg">üì±</span> Twilio
                            </button>
                            <button type="button"
                                @click="activeProfile = 'telnyx'; document.getElementById('sim-mode-text').innerText = 'Telnyx'; document.getElementById('sim-mode-text').className = 'text-emerald-400'; window.simulatorClientType = 'telnyx';"
                                :class="{'bg-emerald-600 text-white shadow-lg scale-[1.02]': activeProfile === 'telnyx', 'text-slate-400 hover:text-white': activeProfile !== 'telnyx'}"
                                class="flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all focus:outline-none flex items-center justify-center gap-2">
                                <span class="text-lg">üì°</span> Telnyx
                            </button>
                        </div>

                        <!-- Tabs Header (RESTORED FOR HISTORY ACCESS) -->
                        <div class=" flex space-x-1 border-b border-slate-700 mb-4 overflow-x-auto pb-1
                        custom-scrollbar">
                            <!-- Model (Disabled/Hidden) -->
                            <button @click.prevent="tab = 'model'"
                                :class="tab === 'model' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                                class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Modelo</button>

                            <!-- Voice (RESTORED) -->
                            <button @click.prevent="tab = 'voice'"
                                :class="tab === 'voice' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                                class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Voz</button>

                            <!-- Transcriber (Disabled/Hidden) -->
                            <!-- Transcriber (RESTORED) -->
                            <button @click.prevent="tab = 'transcriber'"
                                :class="tab === 'transcriber' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                                class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Transcriptor</button>

                            <!-- Functions (RESTORED) -->
                            <button @click.prevent="tab = 'functions'"
                                :class="tab === 'functions' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                                class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Funciones</button>

                            <!-- Advanced (RESTORED) -->
                            <button @click.prevent="tab = 'advanced'"
                                :class="tab === 'advanced' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                                class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Avanzado</button>

                            <!-- HISTORY (ACTIVE) -->
                            <button @click.prevent="tab = 'history'"
                                :class="tab === 'history' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                                class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap font-bold text-emerald-400">Historial</button>

                            <!-- Connectivity (Disabled/Hidden) -->
                            <button @click.prevent="tab = 'connectivity'"
                                :class="tab === 'connectivity' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-400 hover:text-slate-200'"
                                class="px-3 py-1.5 border-b-2 text-sm font-medium whitespace-nowrap opacity-50 cursor-not-allowed"
                                title="Auditando...">Conexi√≥n</button>
                        </div>



                        <form action="/api/config/update" method="POST" class="space-y-4"
                            onsubmit="event.preventDefault(); saveConfig();">
                            <!-- HIDDEN INPUTS AND FORM CONTENT SAME AS BEFORE (RELYING ON CONTEXT MATCH) -->
                            <input type="hidden" name="stt_provider" value="azure">

                            <input type="hidden" name="tts_provider" value="azure">

                            <!-- FROZEN CONFIGURATION STATE (AUDIT MODE) -->
                            <div style="display:none;">
                                <!-- CORE & MODEL (MOVED TO UI) -->
                                <input type="hidden" name="extraction_model" value="{{ config.extraction_model }}">


                                <!-- CORE PHONE (MOVED TO UI) -->


                                <!-- CORE TELNYX (MOVED TO UI) -->


                                <!-- VOICE (MOVED TO UI) -->

                                <!-- VOICE PHONE (MOVED TO UI) -->

                                <!-- VOICE TELNYX (MOVED TO UI) -->


                                <!-- VOICE EXTRAS (MOVED TO UI) -->

                                <!-- TRANSCRIBER & FUNCTIONS -->
                                <input type="hidden" name="stt_language" value="{{ config.stt_language }}">
                                <input type="hidden" name="silence_timeout_ms" value="{{ config.silence_timeout_ms }}">
                                <input type="hidden" name="segmentation_max_time"
                                    value="{{ config.segmentation_max_time }}">
                                <input type="hidden" name="interruption_threshold"
                                    value="{{ config.interruption_threshold }}">
                                <input type="hidden" name="hallucination_blacklist"
                                    value="{{ config.hallucination_blacklist }}">
                                <input type="hidden" name="enable_denoising" value="{{ config.enable_denoising }}">

                                <!-- TRANSCRIBER PHONE -->
                                <input type="hidden" name="stt_provider_phone" value="{{ config.stt_provider_phone }}">
                                <input type="hidden" name="stt_language_phone" value="{{ config.stt_language_phone }}">
                                <input type="hidden" name="interruption_threshold_phone"
                                    value="{{ config.interruption_threshold_phone }}">
                                <input type="hidden" name="silence_timeout_ms_phone"
                                    value="{{ config.silence_timeout_ms_phone }}">
                                <input type="hidden" name="input_min_characters_phone"
                                    value="{{ config.input_min_characters_phone }}">
                                <input type="hidden" name="hallucination_blacklist_phone"
                                    value="{{ config.hallucination_blacklist_phone }}">
                                <input type="hidden" name="enable_denoising_phone"
                                    value="{{ config.enable_denoising_phone }}">



                                <!-- TWILIO FEATURES -->
                                <input type="hidden" name="twilio_machine_detection"
                                    value="{{ config.twilio_machine_detection }}">
                                <input type="hidden" name="twilio_record" value="{{ config.twilio_record }}">
                                <input type="hidden" name="twilio_trim_silence"
                                    value="{{ config.twilio_trim_silence }}">

                                <!-- ADVANCED (Partially moved to UI) -->
                                <input type="hidden" name="idle_timeout" value="{{ config.idle_timeout }}">
                                <input type="hidden" name="idle_message" value="{{ config.idle_message }}">
                                <input type="hidden" name="max_duration" value="{{ config.max_duration }}">
                                <input type="hidden" name="initial_silence_timeout_ms"
                                    value="{{ config.initial_silence_timeout_ms }}">
                                <input type="hidden" name="initial_silence_timeout_ms_phone"
                                    value="{{ config.initial_silence_timeout_ms_phone }}">
                                <input type="hidden" name="initial_silence_timeout_ms_telnyx"
                                    value="{{ config.initial_silence_timeout_ms_telnyx }}">
                                <input type="hidden" name="punctuation_boundaries"
                                    value="{{ config.punctuation_boundaries or '' }}">
                                <input type="hidden" name="enable_end_call" value="{{ config.enable_end_call }}">
                                <input type="hidden" name="enable_dial_keypad" value="{{ config.enable_dial_keypad }}">
                                <input type="hidden" name="transfer_phone_number"
                                    value="{{ config.transfer_phone_number or '' }}">
                                <input type="hidden" name="segmentation_strategy"
                                    value="{{ config.segmentation_strategy }}">
                                <input type="hidden" name="twilio_recording_channels"
                                    value="{{ config.twilio_recording_channels }}">
                            </div>

                            <!-- Tab: Model -->
                            {% include "partials/tab_model.html" %}

                            <!-- Tab: Voice -->
                            {% include "partials/tab_voice.html" %}

                            <!-- Tab: Transcriber -->
                            {% include "partials/tab_transcriber.html" %}

                            <!-- Tab: Functions -->
                            {% include "partials/tab_functions.html" %}

                            <!-- Tab: Advanced -->
                            {% include "partials/tab_advanced.html" %}

                            <!-- üîí LOCKED SECTION: PANEL HISTORIAL (DO NOT EDIT WITHOUT AUTH) -->
                            <!-- Script moved to partials/tab_history.html -->
                            <!-- üîí END LOCKED SECTION -->


                            <!-- END HIDDEN CONFIGURATION SECTION -->

                            <div class="pt-4 border-t border-slate-700"
                                x-show="tab !== 'history' && tab !== 'connectivity'">
                                <button type="button" onclick="saveConfig()"
                                    class="w-full bg-gradient-to-r from-blue-600 to-emerald-600 hover:from-blue-500 hover:to-emerald-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition hover:scale-[1.02] flex items-center justify-center gap-2">
                                    <span>üíæ</span> Guardar Configuraci√≥n Completa
                                </button>
                            </div>
                        </form>

                        <script>
                            async function saveConfig() {
                                const btn = document.querySelector('button[onclick="saveConfig()"]');
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<span>‚è≥</span> Guardando...';
                                btn.disabled = true;

                                const form = document.querySelector('form[action="/api/config/update"]');
                                const formData = new FormData(form);

                                try {
                                    const response = await fetch('/api/config/update', {
                                        method: 'POST',
                                        body: formData
                                    });

                                    if (response.ok) {
                                        btn.innerHTML = '<span>‚úÖ</span> ¬°Guardado!';
                                        btn.classList.add('bg-green-600');
                                        setTimeout(() => {
                                            btn.innerHTML = originalText;
                                            btn.classList.remove('bg-green-600');
                                            btn.disabled = false;
                                        }, 2000);

                                        // Notify Simulator of potentially new settings (e.g. VAD sliders)
                                        if (typeof window.updateSimulatorConfig === 'function') {
                                            // window.updateSimulatorConfig(); // Optional: reload sim config
                                        }
                                    } else {
                                        throw new Error('Error en respuesta');
                                    }
                                } catch (e) {
                                    console.error(e);
                                    btn.innerHTML = '<span>‚ùå</span> Error al Guardar';
                                    btn.classList.add('bg-red-600');
                                    setTimeout(() => {
                                        btn.innerHTML = originalText;
                                        btn.classList.remove('bg-red-600');
                                        btn.disabled = false;
                                    }, 3000);
                                }
                            }
                        </script>

                        <!-- Tab: History -->
                        {% include "partials/tab_history.html" %}

                    </div> <!-- End x-data -->
                </div>

                <!-- Simulator Panel (Sticky, Right Side) -->
                <div class="lg:col-span-2 sticky top-6 self-start space-y-4">
                    <div
                        class="glass-panel p-6 rounded-2xl shadow-xl flex flex-col min-h-[600px] border border-white/10">
                        <div class="flex justify-between items-center mb-6">
                            <script>
                                // Expose Config to Simulator
                                window.simulatorConfig = {
                                    backgroundAudio: "{{ config.background_sound }}",
                                    backgroundUrl: "{{ config.background_sound_url }}"
                                };
                            </script>
                            <div class="flex flex-col">
                                <h2 class="text-xl font-semibold text-emerald-300 flex items-center gap-2">
                                    <span>üß™</span> Simulador
                                </h2>
                                <!-- Client Type Indicator -->
                                <div id="sim-client-wrapper" class="text-[10px] font-mono mt-1 text-slate-400">
                                    Perfil: <span id="sim-mode-text" class="text-blue-400 font-bold">Navegador</span>
                                </div>
                            </div>
                            <button id="start-btn" onclick="toggleCall()"
                                class="px-5 py-2 bg-emerald-600 hover:bg-emerald-500 rounded font-bold shadow-lg transition-all text-sm">
                                Iniciar Prueba
                            </button>
                        </div>

                        <div
                            class="flex-grow bg-slate-900 rounded-lg p-4 border border-slate-600 relative overflow-hidden flex flex-col items-center justify-center min-h-[300px]">
                            <div id="status-indicator" class="text-slate-500 font-mono mb-4 text-lg">Listo para
                                conectar...
                            </div>

                            <!-- Visualizer Canvas -->
                            <canvas id="visualizer" width="600" height="100" class="w-full h-32"></canvas>
                        </div>

                        <!-- SIMULATOR VAD CONTROLS (HIDDEN) -->
                        <div class="mt-4 p-4 bg-slate-900/50 rounded border border-slate-700"
                            style="display:none !important;">
                            <h3 class="text-sm font-mono text-slate-400 mb-2">CONTROLES DE SENSIBILIDAD (VAD)</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1 text-slate-300 flex justify-between">
                                        <span>Sensibilidad Mic (RMS)</span>
                                        <span id="vad-sens-val" class="text-emerald-400">0.05</span>
                                    </label>
                                    <input type="range" id="vad-sensitivity" min="0.005" max="0.2" step="0.005"
                                        value="0.05"
                                        class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                        oninput="document.getElementById('vad-sens-val').innerText = this.value">
                                    <p class="text-[10px] text-slate-500 mt-1">Actual: <span id="cur-rms"
                                            class="font-mono text-blue-400">0.00</span> | M√≠nimo ruido</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1 text-slate-300 flex justify-between">
                                        <span>Umbral de Voz (Frec)</span>
                                        <span id="vad-voice-val" class="text-emerald-400">45</span>
                                    </label>
                                    <input type="range" id="vad-voice-threshold" min="0" max="100" step="5" value="45"
                                        class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                        oninput="document.getElementById('vad-voice-val').innerText = this.value">
                                    <p class="text-[10px] text-slate-500 mt-1">Actual: <span id="cur-voice"
                                            class="font-mono text-blue-400">0</span> | Calidad Voz</p>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-slate-700">
                                <label class="block text-xs font-medium mb-1 text-slate-300 flex justify-between">
                                    <span>Filtro de Ruido (Min Letras)</span>
                                    <span id="min-chars-val" class="text-orange-400">1</span>
                                </label>
                                <input type="range" id="input-min-chars" min="0" max="50" step="1" value="1"
                                    class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                    oninput="document.getElementById('min-chars-val').innerText = this.value; document.getElementById('form-input-min-chars').value = this.value; updateServerConfig('input_min_characters', this.value)">
                                <p class="text-[10px] text-slate-500 mt-1">Ignora textos menores a X letras.
                                    (Recomendado:
                                    20-30 para ambientes ruidosos)</p>
                            </div>
                        </div>

                        <!-- Latest Transcript -->
                        <div class="mt-4 p-4 bg-slate-900/50 rounded border border-slate-700">
                            <h3 class="text-sm font-mono text-slate-400 mb-2">TRANSCRIPCI√ìN EN VIVO</h3>

                            <div id="transcript-box" class="h-40 overflow-y-auto text-sm space-y-2">
                                <!-- Messages inserted by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="/static/js/simulator.js"></script>
</body>

</html>