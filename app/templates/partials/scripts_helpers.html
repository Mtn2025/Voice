<!-- History Management Scripts -->
<script>
    function toggleAllHistory(source) {
        const checkboxes = document.querySelectorAll('.history-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateDeleteButton();
    }

    function updateDeleteButton() {
        const checked = document.querySelectorAll('.history-checkbox:checked').length;
        const btn = document.getElementById('btn-delete-selected');
        if (btn) {
            if (checked > 0) {
                btn.style.display = 'inline-flex';
                // Update text if needed, but the button has inner HTML structure
                const countSpan = btn.querySelector('span');
                // btn.innerHTML re-write might break icon, so let's just show it.
                // The template has "üóëÔ∏è Borrar Seleccionados", we can append count or just show.
                btn.innerHTML = `<span>üóëÔ∏è</span> Borrar (${checked})`;

            } else {
                btn.style.display = 'none';
            }
        }
    }

    async function deleteSelectedCalls() {
        if (!confirm('¬øBorrar llamadas seleccionadas?')) return;

        const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

        // Get API Key from URL
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('api_key') || '';

        try {
            const res = await fetch(`/api/history/delete-selected?api_key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ call_ids: ids })
            });

            if (res.ok) {
                // Trigger HTMX refresh if available, else reload
                if (window.htmx) {
                    htmx.trigger('#history-body', 'refreshHistory');
                } else {
                    window.location.reload();
                }

                // Uncheck main toggle
                const mainToggle = document.querySelector('thead input[type="checkbox"]');
                if (mainToggle) mainToggle.checked = false;

                updateDeleteButton();
            } else {
                alert('Error al borrar');
            }
        } catch (e) {
            console.error(e);
            alert('Error de conexi√≥n');
        }
    }
</script>