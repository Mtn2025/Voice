<!-- TAB START: HISTORIAL -->
<div x-show="activeTab === 'historial'" class="space-y-4 animate-fade-in-up">
    <!-- Filters -->
    <div class="flex space-x-2 bg-slate-900/50 rounded-lg p-1 border border-slate-700">
        <button type="button" @click="activeHistoryFilter = 'all'"
            :class="{'bg-blue-600 text-white': activeHistoryFilter === 'all', 'text-slate-400 hover:text-white': activeHistoryFilter !== 'all'}"
            class="px-3 py-1 rounded text-xs font-bold transition-all">Todos</button>
        <button type="button" @click="activeHistoryFilter = 'browser'"
            :class="{'bg-blue-600 text-white': activeHistoryFilter === 'browser', 'text-slate-400 hover:text-white': activeHistoryFilter !== 'browser'}"
            class="px-3 py-1 rounded text-xs font-bold transition-all">Simulador</button>
        <button type="button" @click="activeHistoryFilter = 'twilio'"
            :class="{'bg-red-600 text-white': activeHistoryFilter === 'twilio', 'text-slate-400 hover:text-white': activeHistoryFilter !== 'twilio'}"
            class="px-3 py-1 rounded text-xs font-bold transition-all">Twilio</button>
        <button type="button" @click="activeHistoryFilter = 'telnyx'"
            :class="{'bg-emerald-600 text-white': activeHistoryFilter === 'telnyx', 'text-slate-400 hover:text-white': activeHistoryFilter !== 'telnyx'}"
            class="px-3 py-1 rounded text-xs font-bold transition-all">Telnyx</button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto rounded border border-slate-700">
        <table class="w-full text-xs text-left text-slate-400">
            <thead class="text-xs text-slate-300 uppercase bg-slate-800">
                <tr>
                    <!-- Checkbox for Bulk Actions -->
                    <th scope="col" class="px-4 py-2 w-8">
                        <input type="checkbox" onclick="toggleAllHistory(this)"
                            class="rounded bg-slate-700 border-slate-600 text-blue-600 focus:ring-blue-600 ring-offset-slate-800 focus:ring-2">
                    </th>
                    <th scope="col" class="px-4 py-2">Fecha</th>
                    <th scope="col" class="px-4 py-2">Fuente</th>
                    <th scope="col" class="px-4 py-2">Duraci√≥n</th>
                    <th scope="col" class="px-4 py-2">Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="history-body" hx-get="/api/history/rows" hx-trigger="refreshHistory from:body">
                {% for call in history %}
                <tr class="border-b border-slate-800 hover:bg-slate-800/50"
                    x-show="activeHistoryFilter === 'all' || activeHistoryFilter === '{{ call.client_type or 'browser' }}'">
                    <td class="px-4 py-2">
                        <input type="checkbox" value="{{ call.id }}"
                            class="history-checkbox rounded bg-slate-700 border-slate-600 text-blue-600 focus:ring-blue-600 ring-offset-slate-800 focus:ring-2"
                            onchange="updateDeleteButton()">
                    </td>
                    <td class="px-4 py-2 font-mono">{{ call.start_time.strftime('%Y-%m-%d %H:%M') }}
                    </td>
                    <td class="px-4 py-2">
                        {% if call.client_type == 'telnyx' %}
                        <span
                            class="px-2 py-0.5 rounded bg-emerald-900/40 text-emerald-400 border border-emerald-700/50">Telnyx</span>
                        {% elif call.client_type == 'twilio' %}
                        <span
                            class="px-2 py-0.5 rounded bg-red-900/40 text-red-400 border border-red-700/50">Twilio</span>
                        {% else %}
                        <span
                            class="px-2 py-0.5 rounded bg-blue-900/40 text-blue-400 border border-blue-700/50">Simulador</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-2 font-mono">
                        {% if call.end_time %}
                        {{ (call.end_time - call.start_time).seconds }}s
                        {% else %}
                        <span class="text-yellow-500 animate-pulse">En curso</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-2">
                        <a href="/dashboard/call/{{ call.id }}?api_key={{ request.query_params.get('api_key', '') }}"
                            class="text-blue-400 hover:underline">Ver</a>
                    </td>
                </tr>
                {% endfor %}
                {% if not history %}
                <tr>
                    <td colspan="5" class="px-4 py-8 text-center text-slate-500 italic">
                        No hay historial disponible.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Bulk Actions Footer -->
    <div class="pt-2 flex justify-between items-center">
        <button id="btn-delete-selected" onclick="deleteSelectedCalls()" style="display: none;"
            class="text-xs bg-red-900/30 text-red-400 px-3 py-1 rounded border border-red-800 hover:bg-red-900/50 transition-all items-center space-x-1">
            <span>üóëÔ∏è</span> Borrar Seleccionados
        </button>

        <form action="/api/history/clear?api_key={{ request.query_params.get('api_key', '') }}" method="POST"
            onsubmit="return confirm('¬øBorrar todo el historial?');">
            <button type="submit" class="text-xs text-red-500 hover:text-red-400 underline decoration-dotted">
                üóëÔ∏è Borrar Historial Completo
            </button>
        </form>
    </div>
</div>